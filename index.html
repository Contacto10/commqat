<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATIP - Gestión de Proyectos</title>
    <!-- Content Security Policy: allow required external endpoints for Firebase and Google Docs during testing.
        Note: runtime template compilation in-browser uses Function/eval; either precompile templates
        (recommended) or allow 'unsafe-eval' here. Tighten this policy for production (use HTTP header).
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data:; script-src 'self' https: 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https:; font-src 'self' data: https:; connect-src 'self' https://identitytoolkit.googleapis.com https://www.googleapis.com https://firestore.googleapis.com https://*.googleapis.com https://securetoken.googleapis.com https://*.firebaseio.com https:; frame-src 'self' https://docs.google.com https://accounts.google.com https:; img-src 'self' data:;">
    <!-- use production Vue build to remove dev warnings -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <section v-if="user">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>ATIP - Gestión de Proyectos <span v-if="selectedProjectObject" :style="{ color: '#8ab4f8' }">- {{ selectedProjectObject.nombre }}</span></h1>
                <div>
                    <span>{{ user.email }}</span>
                    <button @click="handleLogout" style="margin-left: 1rem; width: auto; padding: 0.5rem 1rem;">Cerrar Sesión</button>
                </div>
            </header>

            <main v-if="currentView === 'projectSelection'">

                <!-- Secciones generales -->
                <div class="project-selection-cards">
                    <div class="dashboard-card">
                        <span class="card-icon" aria-hidden="true">
                            <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-clipboard"></use></svg>
                        </span>
                        <h2>Tareas por ejecutar</h2>
                        <p>Gestión de tareas y prioridades.</p>
                        <div class="card-buttons">
                            <button class="btn-secondary" title="Gestionar tareas" @click="currentView = 'taskManagement'">Gestion de Tareas</button>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <span class="card-icon" aria-hidden="true">
                            <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-helmet"></use></svg>
                        </span>
                        <h2>Gestión HSE</h2>
                        <p>Gestión de permisos de trabajo.</p>
                        <div class="card-buttons">
                            <button class="btn-secondary" title="Administrar permisos de trabajo" @click="currentView = 'workPermits'">Permisos de Trabajo</button>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <span class="card-icon" aria-hidden="true">
                            <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-shield"></use></svg>
                        </span>
                        <h2>Preservación</h2>
                        <p>Gestión de la preservación de equipos y materiales.</p>
                        <div class="card-buttons">
                            <button class="btn-secondary" title="Abrir la hoja de consumibles" @click="currentView = 'consumablesManagement'">Gestion de Consumibles</button>
                            <button class="btn-secondary" title="Ver/editar el plan de preservación" @click="currentView = 'preservationPlan'">Plan de Preservacion</button>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <span class="card-icon" aria-hidden="true">
                            <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-clipboard"></use></svg>
                        </span>
                        <h2>Talento Humano</h2>
                        <p>Gestión del personal y asignaciones.</p>
                        <div class="card-buttons">
                            <button class="btn-secondary" title="Gestionar talento humano" @click="currentView = 'humanResources'">Gestionar Talento</button>
                        </div>
                    </div>
                </div>
                <h2>Seleccionar Proyecto</h2>
                <div class="project-selector">
                    <select v-model="selectedProject">
                        <option disabled value="">Seleccione un proyecto</option>
                        <option v-for="project in projects" :key="project.id" :value="project.id">{{ project.nombre }}</option>
                    </select>
                    <button @click="currentView = 'dashboard'" :disabled="!selectedProject">Ir al Proyecto</button>
                    <button @click="openEditProjectModal(selectedProjectObject)" :disabled="!selectedProject" class="btn-secondary">Editar Proyecto</button>
                    <button @click="currentView = 'createProject'" class="btn-secondary">Crear Nuevo Proyecto</button>
                </div>
            </main>

            <main v-if="currentView === 'createProject'">
                <h2>Crear Nuevo Proyecto</h2>
                <form @submit.prevent="createProject">
                    <div class="form-group">
                        <label for="projectName">Nombre del Proyecto</label>
                        <input type="text" id="projectName" v-model="newProjectName" required>
                    </div>
                    <div class="form-group">
                        <label for="projectDescription">Descripción del Proyecto</label>
                        <textarea id="projectDescription" v-model="newProjectDescription"></textarea>
                    </div>
                    <button type="submit">Crear Proyecto</button>
                    <button @click="currentView = 'projectSelection'" class="btn-secondary">Cancelar</button>
                </form>
            </main>

            <main v-if="currentView === 'dashboard'" class="dashboard">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button @click="currentView = 'projectSelection'" class="btn-secondary" style="width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                    <button @click="goToEngineeringData" :disabled="!selectedProject" class="btn-secondary" style="width: auto; padding: 0.5rem 1rem;">Datos de Ingenieria</button>
                </div>
                <div class="dashboard-card">
                    <span class="card-icon" aria-hidden="true">
                        <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-clipboard"></use></svg>
                    </span>
                    <h2>Faltantes constructivos</h2>
                    <p>Gestión de pendientes constructivos del proyecto.</p>
                    <div class="card-buttons">
                        <button class="btn-secondary" title="Cargar faltantes desde formulario o Excel" @click="currentView = 'createMissingItem'">Cargue de Faltantes</button>
                        <button class="btn-secondary" title="Ver y gestionar la lista de faltantes" @click="currentView = 'missingItemsManagement'">Gestion de Faltantes</button>
                    </div>
                </div>
                <div class="dashboard-card">
                    <span class="card-icon" aria-hidden="true">
                        <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-check"></use></svg>
                    </span>
                    <h2>Pruebas Funcionales</h2>
                    <p>Gestión de pruebas funcionales y comisionamiento.</p>
                    <div class="card-buttons">
                        <button class="btn-secondary" title="Abrir el gestor de pruebas funcionales" @click="currentView = 'functionalTests'">Gestion de Pruebas</button>
                    </div>
                </div>
            </main>

            <!-- Human Resources management view -->
            <main v-if="currentView === 'humanResources'">
                <button @click="currentView = 'projectSelection'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                <h2>Gestionar Talento Humano</h2>

                <div style="margin-bottom: 1rem; display:flex; gap:0.5rem; align-items:center;">
                    <input type="text" v-model="userFilter" placeholder="Filtrar por nombre o correo..." style="flex:1; padding:0.5rem;">
                    <button class="btn-secondary" @click="loadUsers">Refrescar</button>
                </div>

                <div>
                    <table class="missing-items-table" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th>Nombre</th>
                                <th>Contacto (Correo)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(u, idx) in filteredUsers" :key="u.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ u.fullName || u.name || '-' }}</td>
                                <td><a :href="`mailto:${u.email}`">{{ u.email }}</a></td>
                                <td>
                                    <button class="btn-secondary" @click="openEditUser(u)">Editar</button>
                                </td>
                            </tr>
                            <tr v-if="filteredUsers.length === 0">
                                <td colspan="4" style="text-align:center; color:var(--secondary-color);">No se encontraron usuarios.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="showEditUserModal" class="modal">
                    <div class="modal-content">
                        <span class="close" @click="closeEditUserModal">&times;</span>
                        <h3>Editar Usuario</h3>
                        <form @submit.prevent="saveUser">
                            <div class="form-group">
                                <label for="edit-user-name">Nombre</label>
                                <input id="edit-user-name" type="text" v-model="editedUser.fullName" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-user-email">Correo</label>
                                <input id="edit-user-email" type="email" v-model="editedUser.email" required>
                            </div>
                            <div style="display:flex; gap:0.5rem; justify-content:center; margin-top:1rem;">
                                <button type="submit">Guardar</button>
                                <button type="button" class="btn-secondary" @click="closeEditUserModal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>

            <main v-if="currentView === 'functionalTests'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Gestión de Pruebas Funcionales</h2>
                <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input type="text" v-model="instrumentFilter" placeholder="Filtrar instrumentos..." style="flex:1; padding:0.5rem;">
                    <input list="eqMayorList" v-model="eqMayorFilter" placeholder="Filtrar por Eq Mayor" style="width: 220px; padding:0.5rem;">
                    <datalist id="eqMayorList">
                        <option v-for="opt in eqMayorOptions" :key="opt" :value="opt">{{ opt }}</option>
                    </datalist>
                </div>
                
                <p style="margin-bottom: 1rem;">
                    Mostrando {{ incompleteInstruments.length }} instrumentos pendientes y {{ completedInstruments.length }} completados.
                </p>

                <div>
                    <button class="table-toggle" @click="toggleTable('functionalIncomplete')" :aria-pressed="tableOpen.functionalIncomplete">{{ tableOpen.functionalIncomplete ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                    <div class="responsive-table" v-show="tableOpen.functionalIncomplete">
                    <table class="missing-items-table">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>Eq Mayor</th>
                            <th>Instrumento</th>
                            <th>Avance</th>
                            <th>Fecha de Cierre</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(instrument, idx) in incompleteInstruments" :key="instrument.id">
                            <td>{{ idx + 1 }}</td>
                            <td>{{ instrument.eqMayor || instrument.equipoMayor || '-' }}</td>
                            <td>{{ instrument.name }}</td>
                            <td>{{ getFunctionalTestProgress(instrument.id) }}</td>
                            <td>{{ getFunctionalTestFechaCierre(instrument.id) }}</td>
                            <td>
                                <button @click="openFunctionalTestModal(instrument)" class="btn-secondary">Editar</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>
                
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Pruebas Completadas</h3>
                <div>
                    <button class="table-toggle" @click="toggleTable('functionalCompleted')" :aria-pressed="tableOpen.functionalCompleted">{{ tableOpen.functionalCompleted ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                    <div class="responsive-table" v-show="tableOpen.functionalCompleted">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th>Eq Mayor</th>
                                <th>Instrumento</th>
                                <th>Avance</th>
                                <th>Fecha de Cierre</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(instrument, idx) in completedInstruments" :key="instrument.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ instrument.eqMayor || instrument.equipoMayor || '-' }}</td>
                                <td>{{ instrument.name }}</td>
                                <td>{{ getFunctionalTestProgress(instrument.id) }}</td>
                                <td>{{ getFunctionalTestFechaCierre(instrument.id) }}</td>
                                <td>
                                    <button @click="openFunctionalTestModal(instrument)" class="btn-secondary">Ver/Editar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Motor tests management -->
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Pruebas de Motores</h3>
                <div style="margin-bottom:1rem;">
                    <button class="table-toggle" @click="toggleTable('motorTests')" :aria-pressed="tableOpen.motorTests">{{ tableOpen.motorTests ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                </div>
                <div class="responsive-table" v-show="tableOpen.motorTests">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th>Eq Mayor</th>
                                <th>Motor</th>
                                <th>Avance</th>
                                <th>Fecha Programada</th>
                                <th>Fecha Ejecución</th>
                                <th>Editar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, idx) in motorsWithTests" :key="row.motor.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ row.motor.eqMayor || row.motor.equipoMayor || '-' }}</td>
                                <td>{{ row.motor.name || '-' }}</td>
                                <td>{{ row.test ? ((typeof row.test.progress === 'number') ? (row.test.progress + '%') : (row.test.progress || row.test.avance || '0%')) : '0%' }}</td>
                                <td>{{ row.test ? (row.test.fechaProgramada || '-') : '-' }}</td>
                                <td>{{ row.test ? (row.test.fechaEjecucion || '-') : '-' }}</td>
                                <td><button class="btn-secondary" @click="openMotorTestModalForMotor(row.motor, row.test)">Editar</button></td>
                            </tr>
                            <tr v-if="(motorsWithTests || []).length === 0"><td colspan="6" style="text-align:center; color:var(--secondary-color);">No hay motores registrados.</td></tr>
                        </tbody>
                    </table>
                </div>
            </main>

            <div v-if="showFunctionalTestModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeFunctionalTestModal">&times;</span>
                    <h2>Prueba Funcional para {{ selectedInstrument.name }}</h2>
                    <form @submit.prevent="saveFunctionalTest">
                        <div class="form-group">
                            <label for="marca">Marca</label>
                            <input type="text" id="marca" v-model="newFunctionalTest.marca">
                        </div>
                        <div class="form-group">
                            <label for="modelo">Modelo</label>
                            <input type="text" id="modelo" v-model="newFunctionalTest.modelo">
                        </div>
                        <div class="form-group">
                            <label for="serial">Serial</label>
                            <input type="text" id="serial" v-model="newFunctionalTest.serial">
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" v-model="newFunctionalTest.ajusteCero"> Ajuste de cero</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaLazo"> Prueba de Lazo</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaAlarma"> Prueba Alarma</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaDesconexion"> Prueba Desconexion</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.limitesSaturacion"> Limites de Saturacion</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaSensorDesconectado"> Prueba Sensor desconectado</label>
                        </div>
                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" v-model="newFunctionalTest.observaciones"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fechaCierre">Fecha de Cierre</label>
                            <input type="date" id="fechaCierre" v-model="newFunctionalTest.fechaCierre" aria-label="Fecha de Cierre de la prueba">
                        </div>
                        <button type="submit">Guardar</button>
                    </form>
                </div>
            </div>

            <!-- Motor test checklist modal -->
            <div v-if="showMotorTestModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeMotorTestModal">&times;</span>
                    <h2>Checklist Prueba Motor - {{ editedMotorTest && (editedMotorTest.eqMayor || editedMotorTest.equipoMayor || editedMotorTest.name) }}</h2>
                    <form @submit.prevent="saveMotorTest">
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.energizacionGaveta"> Energizacion Gaveta o Variador</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.comunicacionGaveta"> Comunicacion con Gaveta o Variador</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.verificacionControl"> Verificacion Control</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.energizacionMotor"> Energizacion Motor</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.sentidoGiro"> Sentido de giro Motor</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.soloRun"> Solo Run</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.pruebasInterlocks"> Pruebas interlocks</label></div>
                        <div class="form-group"><label><input type="checkbox" v-model="editedMotorTest.acopleMotor"> Acople Motor</label></div>
                        <div class="form-group">
                            <label for="motor-fecha-programada">Fecha Programada</label>
                            <input id="motor-fecha-programada" type="date" v-model="editedMotorTest.fechaProgramada">
                        </div>
                        <div class="form-group">
                            <label for="motor-fecha-ejecucion">Fecha Ejecución</label>
                            <input id="motor-fecha-ejecucion" type="date" v-model="editedMotorTest.fechaEjecucion">
                        </div>
                        <div style="display:flex; gap:0.5rem; justify-content:center; margin-top:1rem;">
                            <button type="submit">Guardar</button>
                            <button type="button" class="btn-secondary" @click="closeMotorTestModal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <div v-if="showEditProjectModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeEditProjectModal">&times;</span>
                    <h2>Editar Proyecto</h2>
                    <form @submit.prevent="updateProject">
                        <div class="form-group">
                            <label for="editProjectName">Nombre del Proyecto</label>
                            <input type="text" id="editProjectName" v-model="editedProjectName" required>
                        </div>
                        <div class="form-group">
                            <label for="editProjectDescription">Descripción del Proyecto</label>
                            <textarea id="editProjectDescription" v-model="editedProjectDescription"></textarea>
                        </div>
                        <button type="submit">Guardar Cambios</button>
                    </form>
                </div>
            </div>

            <main v-if="currentView === 'preservationPlan'">
                <button @click="currentView = 'projectSelection'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                <h2>Plan de Preservación</h2>
                <div class="iframe-container">
                </div>
            </main>

            <main v-if="currentView === 'consumablesManagement'">
                <button @click="currentView = 'projectSelection'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                <h2>Gestión de Consumibles</h2>
                <div v-if="user && (user.email === 'contacto10@gmail.com' || user.email === 'garibello.ignacio@gmail.com')" style="margin-bottom: 1rem;">
                    <a href="https://forms.gle/vcndBzx6XUMngBto8" target="_blank" class="btn-secondary" style="display: inline-block; text-decoration: none; padding: 0.5rem 1rem;">Gestion de Consumibles</a>
                </div>
                <div class="iframe-container">
                    <iframe title="Hoja de Consumibles" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYtfoxXN6eezzw1lRh9UpAHui58k_2efsRCDhi43rlS818KnpfNOGUEoBeIV3c80QojFB3Ch1mHMbU/pubhtml?gid=1474824512&single=true&widget=false&headers=false&chrome=false&theme=light&embed=true" style="width: 100%; height: 600px; border: none; margin: 0; padding: 0; overflow: hidden; position: relative; "></iframe>
                </div>
            </main>

            <main v-if="currentView === 'workPermits'">
                <button @click="currentView = 'projectSelection'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                <h2>Permisos de Trabajo</h2>
                <button @click="showWorkPermitForm = true" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Cargar Permiso</button>
                <div class="iframe-container">
                </div>
                <dialog v-if="showWorkPermitForm" class="modal" id="workpermit-dialog" aria-labelledby="workpermit-title" open>
                    <div class="modal-content">
                        <button class="close" aria-label="Cerrar" @click="showWorkPermitForm = false">&times;</button>
                        <h3 id="workpermit-title">Cargar Permiso de Trabajo</h3>
                        <form @submit.prevent="submitWorkPermit">
                            <div class="form-group"><label for="wp-numero">#</label><input id="wp-numero" type="text" v-model="newWorkPermit.numero" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-fechaSolicitud">Fecha de Solicitud</label><input id="wp-fechaSolicitud" type="date" v-model="newWorkPermit.fechaSolicitud" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-fechaInicio">Fecha de Inicio</label><input id="wp-fechaInicio" type="date" v-model="newWorkPermit.fechaInicio" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-fechaFin">Fecha de Finalización</label><input id="wp-fechaFin" type="date" v-model="newWorkPermit.fechaFin" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-tipo">Tipo de Permiso</label><input id="wp-tipo" type="text" v-model="newWorkPermit.tipoPermiso" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-area">Área</label><input id="wp-area" type="text" v-model="newWorkPermit.area" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-empresa">Empresa ejecutora</label><input id="wp-empresa" type="text" v-model="newWorkPermit.empresaEjecutora" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-especialidad">Especialidad</label><input id="wp-especialidad" type="text" v-model="newWorkPermit.especialidad" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-descripcion">Descripción</label><textarea id="wp-descripcion" v-model="newWorkPermit.descripcion" required aria-required="true"></textarea></div>
                            <div class="form-group"><label for="wp-estado">Estado</label><input id="wp-estado" type="text" v-model="newWorkPermit.estado" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-subestado">Sub-estado</label><input id="wp-subestado" type="text" v-model="newWorkPermit.subestado" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-valoracion">Valoración del Riesgo</label><input id="wp-valoracion" type="text" v-model="newWorkPermit.valoracionRiesgo" required aria-required="true"></div>
                            <div style="margin-top: 1rem; display:flex; gap:0.5rem; align-items:center; justify-content:center;">
                                <button type="submit" :disabled="isSavingWorkPermit">Guardar Permiso
                                    <span v-if="isSavingWorkPermit" class="inline-spinner" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn-secondary" @click="showWorkPermitForm = false" :disabled="isSavingWorkPermit">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </dialog>
                <output v-if="toastVisible" class="toast" aria-live="polite">{{ toastMessage }}</output>
            </main>

            <main v-if="currentView === 'createMissingItem'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Cargar Faltante Constructivo</h2>
                <div style="margin-bottom: 1rem;">
                    <input type="file" @change="handleFileUpload" accept=".xls,.xlsx" ref="fileInput" style="display: none;">
                    <button class="btn-secondary" @click="$refs.fileInput.click()">Cargue Masivo desde Excel</button>
                    <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                        El archivo de Excel debe contener las siguientes columnas: Equipo, Descripcion, Tipo (Tipo A o Tipo B), FechaCierre (YYYY-MM-DD)
                    </p>
                </div>
                <form @submit.prevent="createMissingItem">
                    <div class="form-group">
                        <label for="missingItemProject">Proyecto</label>
                        <input type="text" id="missingItemProject" :value="selectedProjectObject.nombre" disabled>
                    </div>
                    <div class="form-group">
                        <label for="missingItemEquipment">Equipo</label>
                        <input type="text" id="missingItemEquipment" v-model="newMissingItem.equipment" required>
                    </div>
                    <div class="form-group">
                        <label for="missingItemDescription">Descripción del Faltante</label>
                        <textarea id="missingItemDescription" v-model="newMissingItem.description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="missingItemType">Tipo de Faltante</label>
                        <select id="missingItemType" v-model="newMissingItem.type" required>
                            <option value="Tipo A">Tipo A</option>
                            <option value="Tipo B">Tipo B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="missingItemDate">Fecha Tentativa de Cierre</label>
                        <input type="date" id="missingItemDate" v-model="newMissingItem.closingDate" required>
                    </div>
                    <button type="submit">Crear Faltante</button>
                </form>
            </main>

            <main v-if="currentView === 'missingItemsManagement'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Gestión de Faltantes</h2>

                <div class="filter-buttons" style="margin-bottom: 1rem;">
                    <button @click="setMissingItemsFilter('All')" class="btn-secondary">Mostrar Todos</button>
                    <button @click="setMissingItemsFilter('A')" class="btn-secondary">Filtrar Tipo A</button>
                    <button @click="setMissingItemsFilter('B')" class="btn-secondary">Filtrar Tipo B</button>
                </div>

                <div class="summary" style="margin-bottom: 1rem;">
                    <p>Faltantes Tipo A: {{ summaryCounts.totalA }} (Abiertos: {{ summaryCounts.openA }}, Cerrados: {{ summaryCounts.closedA }})</p>
                    <p>Faltantes Tipo B: {{ summaryCounts.totalB }} (Abiertos: {{ summaryCounts.openB }}, Cerrados: {{ summaryCounts.closedB }})</p>
                </div>

                <div>
                    <button class="table-toggle" @click="toggleTable('missingItems')" :aria-pressed="tableOpen.missingItems">{{ tableOpen.missingItems ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                    <div class="responsive-table" v-show="tableOpen.missingItems">
                    <table class="missing-items-table">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th @click="sortMissingItems('equipment')">
                                Equipo
                                <span v-if="missingItemsSortColumn === 'equipment'">
                                    <span v-if="missingItemsSortOrder === 'asc'">▲</span>
                                    <span v-else>▼</span>
                                </span>
                            </th>
                            <th>Descripción</th>
                            <th>Tipo</th>
                            <th>Fecha Cierre</th>
                                <th>Avance</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, idx) in filteredMissingItems" :key="item.id">
                            <td>{{ idx + 1 }}</td>
                            <td>{{ item.equipment }}</td>
                            <td>{{ item.description }}</td>
                            <td>{{ item.type }}</td>
                            <td>{{ item.closingDate }}</td>
                            <td>{{ item.status }}</td>
                            <td>
                                <button @click="toggleMissingItemStatus(item)" :class="item.status === 'Abierto' ? 'btn-open' : 'btn-closed'">
                                    {{ item.status === 'Abierto' ? 'Cerrar' : 'Abrir' }}
                                </button>
                            </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </main>

            <main v-if="currentView === 'engineeringData'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Datos de Ingeniería</h2>

                <div class="engineering-section">
                    <h3>Descripción del Proyecto</h3>
                    <p>{{ selectedProjectObject.description || 'No hay descripción para este proyecto.' }}</p>
                </div>

                <div class="engineering-section">
                    <h3>Instrumentos Comisionables</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.instrumentsFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('instruments', engineeringData.instruments)" class="btn-secondary">Editar Información</button>
                        <button class="table-toggle" @click="toggleTable('instruments')" :aria-pressed="tableOpen.instruments">{{ tableOpen.instruments ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Instrumento, Rango, Alarmas, Interlocks. Los registros se actualizarán si ya existen (upsert) para evitar duplicados.
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('instruments', $event)" ref="instrumentsFileInput" style="display: none;" accept=".xls,.xlsx">
                    <div class="responsive-table" v-show="tableOpen.instruments">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                    <th>ITEM</th>
                                    <th>Eq Mayor</th>
                                    <th @click="sortEngineering('instruments', 'name')" style="cursor:pointer;">
                                        Instrumento
                                    <span v-if="engineeringSort.type === 'instruments' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">▲</span>
                                        <span v-else>▼</span>
                                    </span>
                                    </th>
                                    <th>Descripción</th>
                                    <th>Rango</th>
                                <th>Alarmas</th>
                                <th>Interlocks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(instrument, idx) in sortedEngineeringInstruments" :key="instrument.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ instrument.eqMayor || instrument.equipoMayor || '-' }}</td>
                                    <td>{{ instrument.name }}</td>
                                    <td>{{ instrument.description || instrument.Descripcion || '-' }}</td>
                                    <td>{{ instrument.range }}</td>
                                <td>{{ instrument.alarms }}</td>
                                <td>{{ instrument.interlocks }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="engineering-section">
                    <h3>Interlocks</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.interlocksFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('interlocks', engineeringData.interlocks)" class="btn-secondary">Editar Información</button>
                        <button class="table-toggle" @click="toggleTable('interlocks')" :aria-pressed="tableOpen.interlocks">{{ tableOpen.interlocks ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Interlock, Causa, Efecto. Los registros se actualizarán si ya existen (upsert) sobre el campo "Interlock".
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('interlocks', $event)" ref="interlocksFileInput" style="display: none;" accept=".xls,.xlsx">
                    <div class="responsive-table" v-show="tableOpen.interlocks">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th @click="sortEngineering('interlocks', 'name')" style="cursor:pointer;">
                                    Interlock
                                    <span v-if="engineeringSort.type === 'interlocks' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">▲</span>
                                        <span v-else>▼</span>
                                    </span>
                                </th>
                                <th>Causa</th>
                                <th>Efecto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(interlock, idx) in sortedEngineeringInterlocks" :key="interlock.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ interlock.name }}</td>
                                <td>{{ interlock.causa }}</td>
                                <td>{{ interlock.efecto }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="engineering-section">
                    <h3>Motores</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.motorsFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('motors', engineeringData.motors)" class="btn-secondary">Editar Información</button>
                        <button class="table-toggle" @click="toggleTable('motors')" :aria-pressed="tableOpen.motors">{{ tableOpen.motors ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Motor, Descripcion
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('motors', $event)" ref="motorsFileInput" style="display: none;" accept=".xls,.xlsx" multiple>
                    <div class="responsive-table" v-show="tableOpen.motors">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th>Eq Mayor</th>
                                <th @click="sortEngineering('motors', 'name')" style="cursor:pointer;">
                                    Motor
                                    <span v-if="engineeringSort.type === 'motors' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">▲</span>
                                        <span v-else>▼</span>
                                    </span>
                                </th>
                                <th>Descripción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(motor, idx) in sortedEngineeringMotors" :key="motor.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ motor.eqMayor || motor.equipoMayor || '-' }}</td>
                                <td>{{ motor.name }}</td>
                                <td>{{ motor.description }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="engineering-section">
                    <h3>Lazos de Control</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.controlLoopsFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('controlLoops', engineeringData.controlLoops)" class="btn-secondary">Editar Información</button>
                        <button class="table-toggle" @click="toggleTable('controlLoops')" :aria-pressed="tableOpen.controlLoops">{{ tableOpen.controlLoops ? 'Ocultar tabla' : 'Mostrar tabla' }}</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Lazo, Descripcion
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('controlLoops', $event)" ref="controlLoopsFileInput" style="display: none;" accept=".xls,.xlsx" multiple>
                    <div class="responsive-table" v-show="tableOpen.controlLoops">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th @click="sortEngineering('controlLoops', 'name')" style="cursor:pointer;">
                                    Lazo
                                    <span v-if="engineeringSort.type === 'controlLoops' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">▲</span>
                                        <span v-else>▼</span>
                                    </span>
                                </th>
                                <th>Descripción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(loop, idx) in sortedEngineeringControlLoops" :key="loop.id">
                                <td>{{ idx + 1 }}</td>
                                <td>{{ loop.name }}</td>
                                <td>{{ loop.description }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>

            <div v-if="showEditEngineeringDataModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeEditEngineeringDataModal">&times;</span>
                    <h2>{{ editModalTitle }}</h2>
                    <form @submit.prevent="updateEngineeringData">
                        <div class="form-group">
                            <label for="edit-item-select">Seleccionar Item</label>
                            <select id="edit-item-select" v-model="selectedItemId" @change="loadDataForEditing">
                                <option disabled value="">-- Seleccione un item --</option>
                                <option v-for="item in sortedEditingDataArray" :key="item.id" :value="item.id">
                                    {{ item.name || item.equipment || item.descripcion || item.serial || item.modelo || item.marca || item.id }}
                                </option>
                            </select>
                        </div>

                        <div v-if="selectedItemId">
                            <!-- Dynamic fields based on editingDataType -->
                            <template v-if="editingDataType === 'instruments'">
                                <div class="form-group">
                                    <label for="edit-instrument-name">Instrumento</label>
                                    <input type="text" id="edit-instrument-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-description">Descripción</label>
                                    <input type="text" id="edit-instrument-description" v-model="editedData.description">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-range">Rango</label>
                                    <input type="text" id="edit-instrument-range" v-model="editedData.range">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-alarms">Alarmas</label>
                                    <input type="text" id="edit-instrument-alarms" v-model="editedData.alarms">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-interlocks">Interlocks</label>
                                    <input type="text" id="edit-instrument-interlocks" v-model="editedData.interlocks">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-eqmayor">Eq Mayor</label>
                                    <input type="text" id="edit-instrument-eqmayor" v-model="editedData.eqMayor">
                                </div>
                            </template>
                            <template v-if="editingDataType === 'interlocks'">
                                <div class="form-group">
                                    <label for="edit-interlock-name">Interlock</label>
                                    <input type="text" id="edit-interlock-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-interlock-causa">Causa</label>
                                    <input type="text" id="edit-interlock-causa" v-model="editedData.causa">
                                </div>
                                <div class="form-group">
                                    <label for="edit-interlock-efecto">Efecto</label>
                                    <input type="text" id="edit-interlock-efecto" v-model="editedData.efecto">
                                </div>
                            </template>
                            <template v-if="editingDataType === 'motors'">
                                <div class="form-group">
                                    <label for="edit-motor-name">Motor</label>
                                    <input type="text" id="edit-motor-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-motor-description">Descripción</label>
                                    <input type="text" id="edit-motor-description" v-model="editedData.description">
                                </div>
                            </template>
                            <template v-if="editingDataType === 'controlLoops'">
                                <div class="form-group">
                                    <label for="edit-loop-name">Lazo</label>
                                    <input type="text" id="edit-loop-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-loop-description">Descripción</label>
                                    <input type="text" id="edit-loop-description" v-model="editedData.description">
                                </div>
                            </template>
                        </div>

                        <button type="submit" :disabled="!selectedItemId">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </section>

        <section v-else>
            <div v-if="showLogin">
                <h2>Iniciar Sesión</h2>
                        <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label for="email">Correo Electrónico</label>
                        <input type="email" id="email" name="email" v-model="email" required autocomplete="username">
                    </div>
                        <div class="form-group">
                            <label for="password">Contraseña</label>
                            <div class="password-container">
                                <input v-if="!showPassword" type="password" id="password" name="password" v-model="password" required autocomplete="current-password">
                                <input v-else type="text" id="password-text" v-model="password" aria-hidden="false">
                                <button type="button" class="toggle-password" @click="showPassword = !showPassword" @keydown.enter.prevent="showPassword = !showPassword" :aria-pressed="showPassword" aria-label="Mostrar u ocultar contraseña">👁️</button>
                            </div>
                        </div>
                    <button type="submit">Ingresar</button>
                </form>
                <p>¿No tienes cuenta? <a href="#" @click.prevent="showLogin = false">Regístrate</a></p>
            </div>

            <div v-else>
                <h2>Registrarse</h2>
                <form @submit.prevent="handleRegister">
                        <div class="form-group">
                        <label for="register-name">Nombre y Apellido</label>
                        <input type="text" id="register-name" name="name" v-model="fullName" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="register-email">Correo Electrónico</label>
                        <input type="email" id="register-email" name="email" v-model="email" required autocomplete="email">
                    </div>
                        <div class="form-group">
                            <label for="register-password">Contraseña</label>
                            <div class="password-container">
                            <input v-if="!showPassword" type="password" id="register-password" name="password" v-model="password" required autocomplete="new-password" aria-describedby="register-password-help">
                            <input v-else type="text" id="register-password-text" v-model="password" aria-hidden="false">
                            <button type="button" class="toggle-password" @click="showPassword = !showPassword" @keydown.enter.prevent="showPassword = !showPassword" :aria-pressed="showPassword" aria-label="Mostrar u ocultar contraseña">👁️</button>
                            </div>
                            <small id="register-password-help" style="color:var(--secondary-color);">Usa una contraseña segura de al menos 8 caracteres.</small>
                        </div>
                    <button type="submit">Registrarse</button>
                </form>
                <p>¿Ya tienes cuenta? <a href="#" @click.prevent="showLogin = true">Inicia Sesión</a></p>
            </div>
        </section>

            <main v-if="currentView === 'taskManagement'">
                <button @click="currentView = 'projectSelection'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                    <h2 style="margin:0">Gestión de Tareas</h2>
                    <div>
                        <button class="btn-secondary" style="margin-right:8px; width:auto; padding:0.5rem 0.8rem;" @click="showCreateTaskModal = true">Crear Tarea</button>
                    </div>
                </div>
                <div class="kanban-board">
                    <div class="kanban-column" @dragover.prevent @drop="drop('pendiente')">
                        <h3>Pendiente</h3>
                        <div :class="['kanban-card','pendiente']" v-for="task in tasks.pendiente" :key="task.id" draggable="true" @dragstart="drag(task)">
                            <h4>{{ task.title }}</h4>
                            <p>{{ task.description }}</p>
                        </div>
                    </div>
                    <div class="kanban-column" @dragover.prevent @drop="drop('enProgreso')">
                        <h3>En Progreso</h3>
                        <div :class="['kanban-card','enProgreso']" v-for="task in tasks.enProgreso" :key="task.id" draggable="true" @dragstart="drag(task)">
                            <h4>{{ task.title }}</h4>
                            <p>{{ task.description }}</p>
                            <small v-if="task.assignedTo">Asignado a: {{ task.assignedTo }}</small>
                        </div>
                    </div>
                    <div class="kanban-column" @dragover.prevent @drop="drop('completado')">
                        <h3>Completado</h3>
                        <div :class="['kanban-card','completado']" v-for="task in tasks.completado" :key="task.id" draggable="true" @dragstart="drag(task)">
                            <h4>{{ task.title }}</h4>
                            <p>{{ task.description }}</p>
                            <small v-if="task.assignedTo">Asignado a: {{ task.assignedTo }}</small>
                        </div>
                    </div>
                </div>
                <!-- Create Task Modal -->
                <div v-if="showCreateTaskModal" class="modal">
                    <div class="modal-content">
                        <span class="close" @click="showCreateTaskModal=false">&times;</span>
                        <h3>Crear nueva tarea</h3>
                        <form @submit.prevent="createTask">
                            <div class="form-group"><label>Título</label><input v-model="newTask.title" required></div>
                            <div class="form-group"><label>Descripción</label><input v-model="newTask.description"></div>
                            <div style="display:flex; gap:8px; justify-content:flex-end;">
                                <button type="button" class="btn-secondary" @click="showCreateTaskModal=false">Cancelar</button>
                                <button type="submit">Crear</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
    </div>

    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { createApp } = Vue

            createApp({
                data() {
                    return {
                        email: '',
                        password: '',
                        fullName: '',
                        showLogin: true,
                        user: null,
                        showPassword: false,
                        showLoginErrorModal: false,
                        loginErrorMessage: '',
                        currentView: 'projectSelection',
                        projects: [],
                        selectedProject: '',
                        newProjectName: '',
                        newProjectDescription: '',
                        newMissingItem: {
                            equipment: '',
                            description: '',
                            type: 'Tipo A',
                            closingDate: ''
                        },
                        missingItems: [],
                        missingItemsFilter: 'All',
                        missingItemsSortColumn: 'equipment',
                        missingItemsSortOrder: 'asc',
                        engineeringData: {
                            instruments: [],
                            interlocks: [],
                            motors: [],
                            controlLoops: []
                        },
                        instrumentFilter: '',
                        eqMayorFilter: '',
                        showFunctionalTestModal: false,
                        selectedInstrument: null,
                        showEditProjectModal: false,
                        editingProject: null,
                        editedProjectName: '',
                        editedProjectDescription: '',
                        showEditEngineeringDataModal: false,
                        editingDataType: null,
                        editingDataArray: [],
                        selectedItemId: '',
                        editedData: {},
                        functionalTests: [],
                        newFunctionalTest: {
                            marca: '',
                            modelo: '',
                            serial: '',
                            ajusteCero: false,
                            pruebaLazo: false,
                            pruebaAlarma: false,
                            pruebaDesconexion: false,
                            limitesSaturacion: false,
                            pruebaSensorDesconectado: false,
                            observaciones: '',
                            fechaCierre: ''
                        },
                        showWorkPermitForm: false,
                        newWorkPermit: {
                            numero: '',
                            fechaSolicitud: '',
                            fechaInicio: '',
                            fechaFin: '',
                            tipoPermiso: '',
                            area: '',
                            empresaEjecutora: '',
                            especialidad: '',
                            descripcion: '',
                            estado: '',
                            subestado: '',
                            valoracionRiesgo: ''
                        },
                        engineeringSort: {
                            type: '',
                            field: '',
                            order: 'asc'
                        }
                    ,
                    // which tables are open (visible)
                    tableOpen: {
                        missingItems: false,
                        functionalIncomplete: false,
                        functionalCompleted: false,
                        instruments: false,
                        interlocks: false,
                        motors: false,
                        motorTests: false,
                        controlLoops: false
                    }
                    ,
                    // motor tests state
                    motorTests: [],
                    showMotorTestModal: false,
                    editedMotorTest: null
                    ,
                    // UI state
                    isSavingWorkPermit: false,
                    toastMessage: '',
                    toastVisible: false,
                    // human resources state
                    users: [],
                    userFilter: '',
                    showEditUserModal: false,
                    editedUser: null,
                    tasks: {
                        pendiente: [
                            { id: 1, title: 'Tarea 1', description: 'Descripción de la tarea 1', status: 'pendiente' },
                            { id: 2, title: 'Tarea 2', description: 'Descripción de la tarea 2', status: 'pendiente' },
                        ],
                        enProgreso: [
                            { id: 3, title: 'Tarea 3', description: 'Descripción de la tarea 3', status: 'enProgreso' },
                        ],
                        completado: [
                            { id: 4, title: 'Tarea 4', description: 'Descripción de la tarea 4', status: 'completado' },
                        ]
                    },
                    draggedTask: null,
                    showCreateTaskModal: false,
                    newTask: {
                        title: '',
                        description: ''
                    },
                    // unsubscribe handle for real-time tasks listener
                    tasksUnsubscribe: null,
                }
            },
                computed: {
                    // Combine motors with their tests (lookup by motorId)
                    motorsWithTests() {
                        const motors = this.engineeringData.motors || [];
                        const tests = this.motorTests || [];
                        const lookup = {};
                        tests.forEach(t => { if (t.motorId) lookup[t.motorId] = t; });
                        return motors.map(m => ({ motor: m, test: lookup[m.id] || null }));
                    },
                    eqMayorOptions() {
                        const arr = (this.engineeringData.instruments || []).map(i => i.eqMayor || i.equipoMayor || i.eqmayor || '').filter(Boolean);
                        // unique
                        return [...new Set(arr)].sort((a,b) => a.localeCompare(b, 'es', {sensitivity:'base'}));
                    },
                    filteredUsers() {
                        if (!this.users) return [];
                        const q = (this.userFilter || '').toString().trim().toLowerCase();
                        if (!q) return this.users;
                        return this.users.filter(u => {
                            const name = (u.fullName || u.name || '').toString().toLowerCase();
                            const email = (u.email || '').toString().toLowerCase();
                            return name.includes(q) || email.includes(q);
                        });
                    },
                    sortedEngineeringInstruments() {
                        let arr = this.engineeringData.instruments || [];
                        if (this.engineeringSort.type !== 'instruments' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    sortedEngineeringInterlocks() {
                        let arr = this.engineeringData.interlocks || [];
                        if (this.engineeringSort.type !== 'interlocks' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    sortedEngineeringMotors() {
                        let arr = this.engineeringData.motors || [];
                        if (this.engineeringSort.type !== 'motors' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    sortedEngineeringControlLoops() {
                        let arr = this.engineeringData.controlLoops || [];
                        if (this.engineeringSort.type !== 'controlLoops' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    selectedProjectObject() {
                        if (!this.selectedProject) return null;
                        return this.projects.find(p => p.id === this.selectedProject);
                    },
                    sortedMissingItems() {
                        return [...this.missingItems].sort((a, b) => {
                            const col = this.missingItemsSortColumn;
                            const order = this.missingItemsSortOrder === 'asc' ? 1 : -1;
                            
                            const valA = a[col] ? a[col].toLowerCase() : '';
                            const valB = b[col] ? b[col].toLowerCase() : '';

                            if (valA < valB) return -1 * order;
                            if (valA > valB) return 1 * order;
                            return 0;
                        });
                    },
                    filteredMissingItems() {
                        const itemsToFilter = this.sortedMissingItems;

                        if (this.missingItemsFilter === 'All') {
                            return itemsToFilter;
                        }
                        const filter = `Tipo ${this.missingItemsFilter}`;
                        return itemsToFilter.filter(item => item.type === filter);
                    },
                    summaryCounts() {
                        const totalA = this.missingItems.filter(item => item.type === 'Tipo A').length;
                        const openA = this.missingItems.filter(item => item.type === 'Tipo A' && item.status === 'Abierto').length;
                        const closedA = totalA - openA;
                        const totalB = this.missingItems.filter(item => item.type === 'Tipo B').length;
                        const openB = this.missingItems.filter(item => item.type === 'Tipo B' && item.status === 'Abierto').length;
                        const closedB = totalB - openB;
                        return { totalA, openA, closedA, totalB, openB, closedB };
                    },
                    filteredInstruments() {
                        let list = this.engineeringData.instruments || [];
                        if (this.instrumentFilter) {
                            const q = this.instrumentFilter.toLowerCase();
                            list = list.filter(instrument => (instrument.name || '').toLowerCase().includes(q));
                        }
                        if (this.eqMayorFilter) {
                            const q = (this.eqMayorFilter || '').toString().trim().toLowerCase();
                            list = list.filter(inst => ((inst.eqMayor || inst.equipoMayor || '')).toString().trim().toLowerCase().includes(q));
                        }
                        return list;
                    },
                    incompleteInstruments() {
                        return this.filteredInstruments.filter(instrument => this.getFunctionalTestProgress(instrument.id) !== '100%');
                    },
                    completedInstruments() {
                        return this.filteredInstruments.filter(instrument => this.getFunctionalTestProgress(instrument.id) === '100%');
                    },
                    editModalTitle() {
                        if (!this.editingDataType) return '';
                        const titles = {
                            instruments: 'Instrumentos Comisionables',
                            interlocks: 'Interlocks',
                            motors: 'Motores',
                            controlLoops: 'Lazos de Control'
                        };
                        return `Editar ${titles[this.editingDataType]}`;
                    },
                    sortedEditingDataArray() {
                        if (!this.editingDataArray || !Array.isArray(this.editingDataArray)) return [];
                        // Ordena por el campo 'name', si existe, si no por otros posibles campos
                        return [...this.editingDataArray].sort((a, b) => {
                            const getSortValue = (item) => item.name || item.equipment || item.descripcion || item.serial || item.modelo || item.marca || item.id || '';
                            return getSortValue(a).localeCompare(getSortValue(b), 'es', { sensitivity: 'base' });
                        });
                    },
                },
                watch: {
                    currentView(newView, oldView) {
                        console.log(`currentView changed from ${oldView} to ${newView}`);
                        if (newView === 'missingItemsManagement') {
                            this.loadMissingItems();
                        }
                        if (newView === 'engineeringData') {
                            console.log('Loading engineering data section.');
                            this.loadEngineeringData();
                        }
                        if (newView === 'functionalTests') {
                            this.loadEngineeringData();
                            this.loadFunctionalTests();
                            this.loadMotorTests();
                        }
                        if (newView === 'humanResources') {
                            // Load user list when entering the human resources section
                            this.loadUsers();
                        }
                        if (newView === 'taskManagement') {
                            // Start listening tasks for the selected project
                            this.loadTasks();
                        }
                    }
                    ,
                    selectedProject(newVal, oldVal) {
                        // when project changes, reload engineering data and tasks
                        if (newVal !== oldVal) {
                            this.loadEngineeringData();
                            this.loadFunctionalTests();
                            this.loadMotorTests();
                        }
                    }
                },
                methods: {
                    // Load tasks in real-time for the selected project and map them by status
                    loadTasks() {
                        // detach previous listener if any
                        try {
                            if (this.tasksUnsubscribe && typeof this.tasksUnsubscribe === 'function') {
                                this.tasksUnsubscribe();
                                this.tasksUnsubscribe = null;
                            }
                        } catch (e) { console.warn('Error unsubscribing previous tasks listener', e); }

                        // leerColeccion returns an unsubscribe function for global collections
                        const unsub = leerColeccion('tasks', (err, data) => {
                            if (err) {
                                console.error('Error loading tasks:', err);
                                return;
                            }
                            // Map tasks by status into the kanban columns
                            const pendiente = [];
                            const enProgreso = [];
                            const completado = [];
                            data.forEach(t => {
                                const copy = { ...t };
                                const status = (copy.status || '').toString();
                                if (status === 'enProgreso') enProgreso.push(copy);
                                else if (status === 'completado' || status === 'completo') completado.push(copy);
                                else pendiente.push(copy);
                            });
                            this.tasks = { pendiente, enProgreso, completado };
                        });

                        if (typeof unsub === 'function') this.tasksUnsubscribe = unsub;
                    },
                    toggleTable(key) {
                        if (typeof key !== 'string') return;
                        this.tableOpen[key] = !this.tableOpen[key];
                    },
                    goToEngineeringData() {
                        if (!this.selectedProject) {
                            alert('Por favor, seleccione un proyecto antes de ver los datos de ingeniería.');
                            return;
                        }
                        this.currentView = 'engineeringData';
                        this.$nextTick(() => {
                            this.loadEngineeringData();
                            this.$forceUpdate && this.$forceUpdate();
                        });
                    },
                    sortEngineering(type, field) {
                        if (this.engineeringSort.type === type && this.engineeringSort.field === field) {
                            this.engineeringSort.order = this.engineeringSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.engineeringSort.type = type;
                            this.engineeringSort.field = field;
                            this.engineeringSort.order = 'asc';
                        }
                    },
                    // Human resources: load users and edit
                    loadUsers() {
                        // read all users collection (no projectId filter)
                        if (!firebase || !firebase.firestore) {
                            console.error('Firebase no está disponible para leer usuarios');
                            return;
                        }
                        const usersRef = firebase.firestore().collection('users');
                        usersRef.get().then(qs => {
                            const arr = [];
                            qs.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
                            this.users = arr;
                        }).catch(err => {
                            console.error('Error cargando usuarios:', err);
                        });
                    },
                    openEditUser(user) {
                        this.editedUser = { ...user };
                        this.showEditUserModal = true;
                    },
                    closeEditUserModal() {
                        this.showEditUserModal = false;
                        this.editedUser = null;
                    },
                    saveUser() {
                        if (!this.editedUser || !this.editedUser.id) return;
                        const id = this.editedUser.id;
                        const payload = { fullName: this.editedUser.fullName, email: this.editedUser.email };
                        firebase.firestore().collection('users').doc(id).update(payload)
                            .then(() => {
                                // update local array
                                const idx = this.users.findIndex(u => u.id === id);
                                if (idx !== -1) this.users.splice(idx, 1, { id, ...payload });
                                this.toastMessage = 'Usuario actualizado';
                                this.toastVisible = true;
                                setTimeout(() => this.toastVisible = false, 2500);
                                this.closeEditUserModal();
                            })
                            .catch(err => {
                                console.error('Error actualizando usuario:', err);
                                alert('Error actualizando usuario: ' + (err.message || err));
                            });
                    },
                    getFunctionalTestProgress(instrumentId) {
                        const test = this.functionalTests.find(t => t.instrumentId === instrumentId);
                        if (!test) {
                            return '0%';
                        }

                        // For backwards compatibility, calculate from fields if not stored
                        if (test.completedFields === undefined || test.totalFields === undefined) {
                            const fields = [
                                test.marca, test.modelo, test.serial, test.observaciones,
                                test.ajusteCero, test.pruebaLazo, test.pruebaAlarma,
                                test.pruebaDesconexion, test.limitesSaturacion, test.pruebaSensorDesconectado
                            ];
                            const totalFields = fields.length;
                            const completedFields = fields.reduce((acc, field) => {
                                if (typeof field === 'boolean') return acc + (field ? 1 : 0);
                                if (typeof field === 'string') return acc + (field.trim() !== '' ? 1 : 0);
                                return acc;
                            }, 0);
                            const percentage = (completedFields / totalFields) * 100;
                            return `${Math.round(percentage)}%`;
                        }

                        const percentage = (test.completedFields / test.totalFields) * 100;
                        return `${Math.round(percentage)}%`;
                    },
                    openFunctionalTestModal(instrument) {
                        this.selectedInstrument = instrument;
                        const test = this.functionalTests.find(t => t.instrumentId === instrument.id);
                        if (test) {
                            this.newFunctionalTest = { ...test };
                        } else {
                            this.newFunctionalTest = {
                                marca: '',
                                modelo: '',
                                serial: '',
                                ajusteCero: false,
                                pruebaLazo: false,
                                pruebaAlarma: false,
                                pruebaDesconexion: false,
                                limitesSaturacion: false,
                                pruebaSensorDesconectado: false,
                                observaciones: '',
                                fechaCierre: ''
                            };
                        }
                        this.showFunctionalTestModal = true;
                    },
                    closeFunctionalTestModal() {
                        this.showFunctionalTestModal = false;
                        this.selectedInstrument = null;
                    },
                    saveFunctionalTest() {
                        if (!this.selectedInstrument) {
                            alert('Seleccione un instrumento antes de guardar la prueba.');
                            return;
                        }

                        const instrumentId = this.selectedInstrument.id;
                        const instrumentUpdate = {
                            marca: this.newFunctionalTest.marca || '',
                            modelo: this.newFunctionalTest.modelo || '',
                            serial: this.newFunctionalTest.serial || ''
                        };

                        // Prepare the prueba (functional test) data WITHOUT marca/modelo/serial
                        const pruebaData = {
                            projectId: this.selectedProject,
                            instrumentId: instrumentId, // will be set or created below
                            observaciones: this.newFunctionalTest.observaciones || '',
                            fechaCierre: this.newFunctionalTest.fechaCierre || '',
                            ajusteCero: !!this.newFunctionalTest.ajusteCero,
                            pruebaLazo: !!this.newFunctionalTest.pruebaLazo,
                            pruebaAlarma: !!this.newFunctionalTest.pruebaAlarma,
                            pruebaDesconexion: !!this.newFunctionalTest.pruebaDesconexion,
                            limitesSaturacion: !!this.newFunctionalTest.limitesSaturacion,
                            pruebaSensorDesconectado: !!this.newFunctionalTest.pruebaSensorDesconectado
                        };

                        // Compute completion based only on the prueba fields (excluding marca/modelo/serial)
                        const fields = [
                            pruebaData.observaciones, pruebaData.fechaCierre,
                            pruebaData.ajusteCero, pruebaData.pruebaLazo, pruebaData.pruebaAlarma,
                            pruebaData.pruebaDesconexion, pruebaData.limitesSaturacion, pruebaData.pruebaSensorDesconectado
                        ];
                        const totalFields = fields.length;
                        const completedFields = fields.reduce((acc, f) => {
                            if (typeof f === 'boolean') return acc + (f ? 1 : 0);
                            if (typeof f === 'string') return acc + (f.trim() !== '' ? 1 : 0);
                            return acc;
                        }, 0);

                        pruebaData.completedFields = completedFields;
                        pruebaData.totalFields = totalFields;

                        const savePruebaAndClose = (finalInstrumentId) => {
                            pruebaData.instrumentId = finalInstrumentId;
                            // save prueba using existing helper which stores the doc with id = instrumentId
                            guardarPruebaFuncional(pruebaData, (error) => {
                                if (error) {
                                    console.error('Error saving functional test:', error);
                                    alert('Error al guardar la prueba funcional.');
                                } else {
                                    console.log('Functional test saved successfully');
                                    this.closeFunctionalTestModal();
                                }
                            });
                        };

                        // If instrument exists in DB (has id), update it; otherwise create it and get its id
                        if (instrumentId) {
                            // Try to update existing instrument
                            actualizarDatoIngenieria('instruments', instrumentId, instrumentUpdate, (err) => {
                                if (err) {
                                    console.error('Error updating instrument:', err);
                                    // still attempt to save the prueba even if instrument update fails
                                }
                                savePruebaAndClose(instrumentId);
                            });
                        } else {
                            // Create new instrument document and then save prueba
                            guardarDato('instruments', this.selectedProject, { name: this.selectedInstrument.name || '', ...instrumentUpdate })
                                .then((docRef) => {
                                    const newId = docRef.id || (docRef && docRef.id) || null;
                                    if (!newId) {
                                        console.warn('No instrument id returned after creation, using selectedInstrument fallback id');
                                    }
                                    savePruebaAndClose(newId || (this.selectedInstrument && this.selectedInstrument.id));
                                })
                                .catch((err) => {
                                    console.error('Error creating instrument:', err);
                                    alert('Error al guardar los datos del instrumento.');
                                });
                        }
                    },
                    // Motor tests management
                    loadMotorTests() {
                        // read motor tests for the project
                        if (!this.selectedProject) return;
                        leerDatos('motorTests', this.selectedProject, (err, data) => {
                            if (err) {
                                console.error('Error loading motor tests:', err);
                                this.motorTests = [];
                            } else {
                                this.motorTests = data;
                            }
                        });
                    },
                    openMotorTestModal(motorTest) {
                        // kept for backward compatibility: open with raw test
                        this.editedMotorTest = { ...(motorTest || {} ) };
                        const bools = ['energizacionGaveta','comunicacionGaveta','verificacionControl','energizacionMotor','sentidoGiro','soloRun','pruebasInterlocks','acopleMotor'];
                        bools.forEach(b => { if (this.editedMotorTest[b] === undefined) this.editedMotorTest[b] = false; });
                        this.showMotorTestModal = true;
                    },
                    openMotorTestModalForMotor(motor, motorTest) {
                        // motor: object from engineeringData.motors
                        // motorTest: existing test or null
                        if (motorTest) {
                            this.editedMotorTest = { ...motorTest };
                        } else {
                            this.editedMotorTest = {
                                motorId: motor.id,
                                eqMayor: motor.eqMayor || motor.equipoMayor || '',
                                fechaProgramada: '',
                                fechaEjecucion: '',
                                energizacionGaveta: false,
                                comunicacionGaveta: false,
                                verificacionControl: false,
                                energizacionMotor: false,
                                sentidoGiro: false,
                                soloRun: false,
                                pruebasInterlocks: false,
                                acopleMotor: false,
                                progress: 0
                            };
                        }
                        this.showMotorTestModal = true;
                    },
                    closeMotorTestModal() {
                        this.showMotorTestModal = false;
                        this.editedMotorTest = null;
                    },
                    saveMotorTest() {
                        if (!this.editedMotorTest) return;
                        // Calculate progress based on checklist
                        const checklistFields = ['energizacionGaveta','comunicacionGaveta','verificacionControl','energizacionMotor','sentidoGiro','soloRun','pruebasInterlocks','acopleMotor'];
                        const total = checklistFields.length;
                        const completed = checklistFields.reduce((acc, f) => acc + (this.editedMotorTest[f] ? 1 : 0), 0);
                        const percent = Math.round((completed / total) * 100);
                        const payload = { ...this.editedMotorTest, projectId: this.selectedProject, progress: percent };
                        // If has id -> update, else create
                        if (payload.id) {
                            actualizarDatoIngenieria('motorTests', payload.id, payload, (err) => {
                                if (err) { alert('Error al guardar prueba de motor'); console.error(err); }
                                else { this.loadMotorTests(); this.closeMotorTestModal(); }
                            });
                        } else {
                            guardarDato('motorTests', this.selectedProject, payload).then((ref) => {
                                this.loadMotorTests();
                                this.closeMotorTestModal();
                            }).catch(err => { alert('Error al crear prueba de motor'); console.error(err); });
                        }
                    },
                    deleteEngineeringMotor(docId) {
                        if (!docId) return;
                        if (!confirm('¿Confirma que desea eliminar este motor de Firestore? Esta acción no se puede deshacer.')) return;
                        eliminarDatoIngenieria('motors', docId, (err) => {
                            if (err) {
                                console.error('Error eliminando motor:', err);
                                alert('Error eliminando el motor.');
                            } else {
                                this.toastMessage = 'Motor eliminado';
                                this.toastVisible = true;
                                setTimeout(() => this.toastVisible = false, 2500);
                                this.loadEngineeringData();
                            }
                        });
                    },
                    getFunctionalTestFechaCierre(instrumentId) {
                        const test = this.functionalTests.find(t => t.instrumentId === instrumentId);
                        if (!test || !test.fechaCierre) return '-';
                        // Handle Firestore Timestamp or ISO string
                        const fecha = test.fechaCierre;
                        if (fecha && typeof fecha.toDate === 'function') {
                            const d = fecha.toDate();
                            return d.toISOString().slice(0,10);
                        }
                        if (typeof fecha === 'string') {
                            const parsed = Date.parse(fecha);
                            if (!isNaN(parsed)) {
                                return new Date(parsed).toISOString().slice(0,10);
                            }
                            return fecha;
                        }
                        return '-';
                    },
                    async submitWorkPermit() {
                        if (!this.selectedProject) {
                            alert('Seleccione un proyecto antes de cargar un permiso.');
                            return;
                        }

                        const permitData = {
                            ...this.newWorkPermit,
                            projectId: this.selectedProject,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        try {
                            this.isSavingWorkPermit = true;
                            await guardarDato('workPermits', this.selectedProject, permitData);
                            // reset form and close modal after successful save
                            this.newWorkPermit = {
                                numero: '',
                                fechaSolicitud: '',
                                fechaInicio: '',
                                fechaFin: '',
                                tipoPermiso: '',
                                area: '',
                                empresaEjecutora: '',
                                especialidad: '',
                                descripcion: '',
                                estado: '',
                                subestado: '',
                                valoracionRiesgo: ''
                            };
                            this.showWorkPermitForm = false;
                            this.toastMessage = 'Permiso cargado correctamente.';
                            this.toastVisible = true;
                            setTimeout(() => { this.toastVisible = false; this.toastMessage = ''; }, 3500);
                        } catch (error) {
                            console.error('Error al guardar permiso:', error);
                            this.toastMessage = 'Error al guardar el permiso. Ver consola para más detalles.';
                            this.toastVisible = true;
                            setTimeout(() => { this.toastVisible = false; this.toastMessage = ''; }, 5000);
                        } finally {
                            this.isSavingWorkPermit = false;
                        }
                    },
                    loadFunctionalTests() {
                        leerDatos('pruebasFuncionales', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading functional tests:', error);
                            }
                            else {
                                this.functionalTests = data;
                            }
                        });
                    },
                    loadEngineeringData() {
                        leerDatos('instruments', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading instruments:', error);
                            }
                            else {
                                this.engineeringData.instruments = data;
                            }
                        });
                        leerDatos('interlocks', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading interlocks:', error);
                            }
                            else {
                                this.engineeringData.interlocks = data;
                            }
                        });
                        leerDatos('motors', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading motors:', error);
                            }
                            else {
                                this.engineeringData.motors = data;
                            }
                        });
                        leerDatos('controlLoops', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading control loops:', error);
                            }
                            else {
                                this.engineeringData.controlLoops = data.map(loop => ({
                                    ...loop,
                                    name: loop.name || loop.Lazo,
                                    description: loop.description || loop.Descripcion
                                }));
                            }
                        });
                    },
                    setMissingItemsFilter(type) {
                        this.missingItemsFilter = type;
                    },
                    sortMissingItems(column) {
                        if (this.missingItemsSortColumn === column) {
                            this.missingItemsSortOrder = this.missingItemsSortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.missingItemsSortColumn = column;
                            this.missingItemsSortOrder = 'asc';
                        }
                    },
                    loadMissingItems() {
                        leerFaltantes(this.selectedProject, (error, faltantes) => {
                            if (error) {
                                console.error('Error loading missing items:', error);
                                alert('Error al cargar los faltantes.');
                            } else {
                                this.missingItems = faltantes.map(item => {
                                    let normalizedType = '';
                                    if (item.type) {
                                        const typeStr = item.type.trim().toLowerCase();
                                        if (typeStr === 'a' || typeStr === 'tipo a') {
                                            normalizedType = 'Tipo A';
                                        } else if (typeStr === 'b' || typeStr === 'tipo b') {
                                            normalizedType = 'Tipo B';
                                        }
                                    }
                                    return {
                                        ...item,
                                        type: normalizedType
                                    };
                                });
                            }
                        });
                    },
                    toggleMissingItemStatus(item) {
                        const newStatus = item.status === 'Abierto' ? 'Cerrado' : 'Abierto';
                        actualizarEstadoFaltante(item.id, newStatus, (error) => {
                            if (error) {
                                console.error('Error updating status:', error);
                                alert('Error al actualizar el estado.');
                            } else {
                                console.log('Status updated successfully');
                            }
                        });
                    },
                    handleFileUpload(event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const json = XLSX.utils.sheet_to_json(worksheet);

                                const faltantes = json.map(row => ({
                                    projectId: this.selectedProject,
                                    equipment: row.Equipo,
                                    description: row.Descripcion,
                                    type: row.Tipo,
                                    closingDate: row.FechaCierre,
                                    status: 'Abierto',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                }));

                                batchSave('faltantes', faltantes, this.selectedProject, (error) => {
                                    if (error) {
                                        console.error('Error saving batch:', error);
                                        alert('Error al cargar los faltantes.');
                                    } else {
                                        alert('Cargue masivo de faltantes exitoso.');
                                    }
                                });
                            };
                            reader.readAsArrayBuffer(file);
                        }
                    },
                    uploadEngineeringData(dataType, event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);

                            // Helper to map rows to documents depending on type
                            const makeDocs = {
                                instruments: (rows) => rows.map(row => ({
                                    name: row.Instrumento || '',
                                    description: row['Descripción'] || row.Descripcion || row.descripcion || '',
                                    range: row.Rango || '',
                                    alarms: row.Alarmas || '',
                                    interlocks: row.Interlocks || '',
                                    eqMayor: row['Eq Mayor'] || row.EqMayor || row.eqMayor || ''
                                })),
                                interlocks: (rows) => rows.map(row => ({
                                    name: (row.Interlock || '').toString().trim(),
                                    causa: row.Causa || '',
                                    efecto: row.Efecto || ''
                                })).filter(d => d.name && d.name.length),
                                motors: (rows) => rows.map(row => ({
                                    name: row.Motor || '',
                                    description: row.Descripcion || '',
                                    eqMayor: row['Eq Mayor'] || row.EqMayor || row.eqMayor || ''
                                })).filter(d => d.name && d.name.length),
                                controlLoops: (rows) => rows.map(row => ({
                                    name: row.Lazo || '',
                                    description: row.Descripcion || ''
                                })).filter(d => d.name && d.name.length)
                            };

                            const docs = (makeDocs[dataType] || (r => r.map(x => ({ ...x })) ))(json);

                            if (dataType === 'instruments') {
                                upsertDocumentsByName(dataType, docs, this.selectedProject, 'name', (error) => {
                                    if (error) {
                                        console.error('Error upserting instruments:', error);
                                        alert('Error al cargar los datos de instrumentos.');
                                    } else {
                                        alert('Cargue masivo de instrumentos exitoso. Los registros existentes fueron actualizados.');
                                        this.loadEngineeringData();
                                    }
                                });
                                return;
                            }

                            // For interlocks, motors, controlLoops we want upsert behavior where possible
                            if (dataType === 'interlocks') {
                                if (docs.length) {
                                    upsertDocumentsByName('interlocks', docs, this.selectedProject, 'name', (error) => {
                                        if (error) {
                                            console.error('Error upserting interlocks:', error);
                                            alert('Error al cargar los interlocks.');
                                        } else {
                                            alert('Cargue masivo de interlocks exitoso. Los registros existentes fueron actualizados.');
                                            this.loadEngineeringData();
                                        }
                                    });
                                    return;
                                }
                            }

                            if (dataType === 'motors' || dataType === 'controlLoops') {
                                // use upsertDocumentsByName for these types to avoid duplicates by name
                                if (docs.length) {
                                    const collection = dataType === 'motors' ? 'motors' : 'controlLoops';
                                    upsertDocumentsByName(collection, docs, this.selectedProject, 'name', (error) => {
                                        if (error) {
                                            console.error(`Error upserting ${collection}:`, error);
                                            alert(`Error al cargar los datos de ${dataType}.`);
                                        } else {
                                            alert(`Cargue masivo de ${dataType} exitoso. Los registros existentes fueron actualizados.`);
                                            this.loadEngineeringData();
                                        }
                                    });
                                    return;
                                }
                            }

                            // Fallback: simple batch save for other types
                            batchSave(dataType, docs, this.selectedProject, (error) => {
                                if (error) {
                                    console.error(`Error saving batch for ${dataType}:`, error);
                                    alert(`Error al cargar los datos de ${dataType}.`);
                                } else {
                                    alert(`Cargue masivo de ${dataType} exitoso.`);
                                }
                            });
                        };
                        reader.readAsArrayBuffer(file);
                    },
                    createMissingItem() {
                        const faltante = {
                            projectId: this.selectedProject,
                            equipment: this.newMissingItem.equipment,
                            description: this.newMissingItem.description,
                            type: this.newMissingItem.type,
                            closingDate: this.newMissingItem.closingDate,
                            status: 'Abierto',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        guardarFaltante(faltante, (error, id) => {
                            if (error) {
                                console.error('Error creating missing item:', error);
                                alert('Error al crear el faltante.');
                            } else {
                                console.log('Missing item created with id:', id);
                                // Reset form
                                this.newMissingItem = {
                                    equipment: '',
                                    description: '',
                                    type: 'Tipo A',
                                    closingDate: ''
                                };
                                this.currentView = 'dashboard';
                            }
                        });
                    },
                    handleLogin() {
                        iniciarSesion(this.email, this.password, (error) => {
                            if (error) {
                                this.loginErrorMessage = 'Usuario o contraseña incorrectos. Por favor, verifique sus datos.';
                                this.showLoginErrorModal = true;
                            }
                        });
                    },
                    
                    handleRegister() {
                        registrar(this.email, this.password, this.fullName, (error) => {
                            if (error) {
                                console.error('Error en el registro:', error);
                                alert('Error en el registro: ' + error);
                            }
                            else {
                                console.log('Registro exitoso, por favor inicie sesión.');
                                this.showLogin = true;
                            }
                        });
                    },
                    handleLogout() {
                        cerrarSesion();
                    },
                    createProject() {
                        crearProyecto(this.newProjectName, this.newProjectDescription, (error, projectId) => {
                            if (error) {
                                console.error('Error creating project:', error);
                            } else {
                                this.newProjectName = '';
                                this.newProjectDescription = '';
                                this.loadProjects();
                                this.currentView = 'projectSelection';
                            }
                        });
                    },
                    loadProjects() {
                        cargarProyectos((error, projects) => {
                            if (error) {
                                console.error('Error loading projects:', error);
                            }
                            else {
                                console.log('Projects loaded:', projects);
                                this.projects = projects;
                            }
                        });
                    },
                    openEditProjectModal(project) {
                        if (!project) return;
                        this.editingProject = project;
                        this.editedProjectName = project.nombre;
                        this.editedProjectDescription = project.description || '';
                        this.showEditProjectModal = true;
                    },
                    closeEditProjectModal() {
                        this.showEditProjectModal = false;
                        this.editingProject = null;
                        this.editedProjectName = '';
                        this.editedProjectDescription = '';
                    },
                    updateProject() {
                        if (!this.editingProject) return;
                        const updatedData = {
                            nombre: this.editedProjectName,
                            description: this.editedProjectDescription
                        };
                        actualizarProyecto(this.editingProject.id, updatedData, (error) => {
                            if (error) {
                                console.error('Error updating project:', error);
                                alert('Error al actualizar el proyecto.');
                            } else {
                                console.log('Project updated successfully');
                                this.closeEditProjectModal();
                                this.loadProjects(); // Reload projects to reflect changes
                            }
                        });
                    },
                    openEditEngineeringDataModal(type, data) {
                        this.editingDataType = type;
                        this.editingDataArray = data;
                        this.showEditEngineeringDataModal = true;
                    },
                    closeEditEngineeringDataModal() {
                        this.showEditEngineeringDataModal = false;
                        this.editingDataType = null;
                        this.editingDataArray = [];
                        this.selectedItemId = '';
                        this.editedData = {};
                    },
                    loadDataForEditing() {
                        if (!this.selectedItemId) {
                            this.editedData = {};
                            return;
                        }
                        const item = this.editingDataArray.find(i => i.id === this.selectedItemId);
                        if (item) {
                            this.editedData = { ...item };
                        }
                    },
                    updateEngineeringData() {
                        if (!this.selectedItemId || !this.editingDataType) return;
                        actualizarDatoIngenieria(this.editingDataType, this.selectedItemId, this.editedData, (error) => {
                            if (error) {
                                console.error('Error updating engineering data:', error);
                                alert('Error al actualizar los datos de ingeniería.');
                            } else {
                                console.log('Engineering data updated successfully');
                                this.closeEditEngineeringDataModal();
                                this.loadEngineeringData(); // Reload data
                            }
                        });
                    }, 
                    deleteEngineeringData(item) {

                        const dataTypeMap = {
                            instruments: 'instrumento',
                            interlocks: 'interlock',
                            motors: 'motor',
                            controlLoops: 'lazo de control'
                        };
                        const typeName = dataTypeMap[this.editingDataType] || 'elemento';
                        if (confirm(`¿Estás seguro de que deseas eliminar el ${typeName} "${item.name}"?`)) {
                            eliminarDatoIngenieria(this.editingDataType, item.id, (error) => {
                                if (error) {
                                    console.error(`Error deleting ${typeName}:`, error);
                                    alert(`Error al eliminar el ${typeName}.`);
                                } else {
                                    alert(`${typeName.charAt(0).toUpperCase() + typeName.slice(1)} eliminado con éxito.`);
                                    // The list will update automatically thanks to onSnapshot
                                }
                            });
                        }
                    },
                    drag(task) {
                        this.draggedTask = task;
                    },
                    drop(status) {
                        const task = this.draggedTask;
                        if (!task) return;
                        const oldStatus = task.status;
                        if (oldStatus !== status) {
                            this.tasks[oldStatus] = this.tasks[oldStatus].filter(t => t.id !== task.id);

                            // If moving to enProgreso and coming from pendiente, assign user
                            if (status === 'enProgreso' && oldStatus === 'pendiente' && this.user) {
                                const assignedTo = this.user.displayName || this.user.email || 'usuario';
                                task.assignedTo = assignedTo;
                                task.assignedAt = firebase.firestore.FieldValue.serverTimestamp();
                            }

                            task.status = status;
                            this.tasks[status].push(task);

                            // Persist change to Firestore regardless of project selection
                            try {
                                if (typeof task.id === 'string' && task.id.length > 10) {
                                    // likely a firestore id -> update
                                    actualizarDatoIngenieria('tasks', task.id, task, (err) => {
                                        if (err) console.error('Error updating task:', err);
                                    });
                                } else {
                                    // create new doc in global tasks collection
                                    guardarDatoGlobal('tasks', { ...task }).then(ref => {
                                        // assign returned id to task to mark persisted
                                        task.id = ref.id || task.id;
                                    }).catch(err => console.error('Error saving task:', err));
                                }
                            } catch (e) {
                                console.error('Error persisting task change:', e);
                            }
                        }
                        this.draggedTask = null;
                    },

                    createTask() {
                        const payload = {
                            title: this.newTask.title || 'Sin título',
                            description: this.newTask.description || '',
                            status: 'pendiente',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: this.user ? (this.user.displayName || this.user.email) : 'anon'
                        };

                        // Save to Firestore (global collection) and then push to local tasks after success
                        guardarDatoGlobal('tasks', payload).then(ref => {
                            this.tasks.pendiente.push({ id: ref.id, ...payload });
                            this.newTask.title = '';
                            this.newTask.description = '';
                            this.showCreateTaskModal = false;
                        }).catch(err => {
                            console.error('Error creating task:', err);
                            this.toastMessage = 'Error al crear tarea. Ver consola.';
                            this.toastVisible = true;
                            setTimeout(() => this.toastVisible = false, 3000);
                        });
                    }
                },
                mounted() {
                    firebase.auth().onAuthStateChanged(async user => {
                        this.user = user;
                        if (user) {
                            this.loadProjects();
                            // start listening global tasks collection
                            this.loadTasks();
                            // Ensure the authenticated user exists in the 'users' collection
                            try {
                                const userRef = firebase.firestore().collection('users').doc(user.uid);
                                const snap = await userRef.get();
                                if (!snap.exists) {
                                    const payload = {
                                        email: user.email || '',
                                        fullName: user.displayName || this.fullName || '',
                                        level: (user.email === 'contacto10@gmail.com') ? 'admin' : 'normal',
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                    };
                                    await userRef.set(payload);
                                    // refresh local users if already loaded
                                    if (this.loadUsers) this.loadUsers();
                                }
                            } catch (err) {
                                console.error('Error ensuring user in users collection:', err);
                            }
                        }
                    });
                }
            }).mount('#app')
        });
    </script>
</body>
</html>