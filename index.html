<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commqat - Login</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; }
        #app { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; }
        input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 0.75rem; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1rem; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div id="app">
        <section v-if="user">
            <h2>Bienvenido, {{ user.email }}</h2>
            <button @click="handleLogout">Cerrar Sesión</button>

            <div class="chat-container">
                <h3>Chat</h3>
                <div class="message-list">
                    <div v-for="message in messages" :key="message.id" class="message">
                        <strong>{{ message.email }}:</strong> {{ message.text }}
                    </div>
                </div>
                <form @submit.prevent="handleSendMessage">
                    <div class="form-group">
                        <input type="text" v-model="newMessage" placeholder="Escribe un mensaje...">
                    </div>
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </section>

        <section v-else>
            <div v-if="showLogin">
                <h2>Iniciar Sesión</h2>
                <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label for="email">Correo Electrónico</label>
                        <input type="email" id="email" v-model="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" v-model="password" required>
                    </div>
                    <button type="submit">Ingresar</button>
                </form>
                <p>¿No tienes cuenta? <a href="#" @click.prevent="showLogin = false">Regístrate</a></p>
            </div>

            <div v-else>
                <h2>Registrarse</h2>
                <form @submit.prevent="handleRegister">
                    <div class="form-group">
                        <label for="email">Correo Electrónico</label>
                        <input type="email" id="email" v-model="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" v-model="password" required>
                    </div>
                    <button type="submit">Registrarse</button>
                </form>
                <p>¿Ya tienes cuenta? <a href="#" @click.prevent="showLogin = true">Inicia Sesión</a></p>
            </div>
        </section>
    </div>

    <script defer src="/__/firebase/12.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    <script src="app.js"></script>
    <script>
        const { createApp } = Vue

        const app = createApp({
            data() {
                return {
                    email: '',
                    password: '',
                    showLogin: true,
                    user: null,
                    messages: [],
                    newMessage: ''
                }
            },
            methods: {
                handleLogin() {
                    iniciarSesion(this.email, this.password);
                },
                handleRegister() {
                    registrar(this.email, this.password);
                },
                handleLogout() {
                    cerrarSesion();
                },
                handleSendMessage() {
                    if (this.newMessage.trim() === '') return;

                    guardarDato('messages', {
                        email: this.user.email,
                        text: this.newMessage,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    this.newMessage = '';
                }
            },
            mounted() {
                auth.onAuthStateChanged(user => {
                    this.user = user;
                    if (user) {
                        leerDatos('messages', (messages) => {
                            this.messages = messages;
                        });
                    }
                });
            }
        }).mount('#app')
    </script>
</body>
</html>