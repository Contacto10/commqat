<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATIP - Gesti√≥n de Proyectos</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <section v-if="user">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>ATIP - Gesti√≥n de Proyectos</h1>
                <div>
                    <span>{{ user.email }}</span>
                    <button @click="handleLogout" style="margin-left: 1rem; width: auto; padding: 0.5rem 1rem;">Cerrar Sesi√≥n</button>
                </div>
            </header>

            <main v-if="currentView === 'projectSelection'">
                <h2>Seleccionar Proyecto</h2>
                <div class="project-selector">
                    <select v-model="selectedProject">
                        <option disabled value="">Seleccione un proyecto</option>
                        <option v-for="project in projects" :key="project.id" :value="project.id">{{ project.nombre }}</option>
                    </select>
                    <button @click="currentView = 'dashboard'" :disabled="!selectedProject">Ir al Proyecto</button>
                    <button @click="currentView = 'createProject'" class="btn-secondary">Crear Nuevo Proyecto</button>
                </div>
            </main>

            <main v-if="currentView === 'createProject'">
                <h2>Crear Nuevo Proyecto</h2>
                <form @submit.prevent="createProject">
                    <div class="form-group">
                        <label for="projectName">Nombre del Proyecto</label>
                        <input type="text" id="projectName" v-model="newProjectName" required>
                    </div>
                    <button type="submit">Crear Proyecto</button>
                    <button @click="currentView = 'projectSelection'" class="btn-secondary">Cancelar</button>
                </form>
            </main>

            <main v-if="currentView === 'dashboard'" class="dashboard">
                <button @click="currentView = 'projectSelection'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                <div class="dashboard-card">
                    <h2>Preservaci√≥n</h2>
                    <p>Gesti√≥n de la preservaci√≥n de equipos y materiales.</p>
                    <div class="card-buttons">
                        <button class="btn-secondary" @click="currentView = 'consumablesManagement'">Gestion de Consumibles</button>
                        <button class="btn-secondary" @click="currentView = 'preservationPlan'">Plan de Preservacion</button>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h2>Faltantes constructivos</h2>
                    <p>Gesti√≥n de pendientes constructivos del proyecto.</p>
                </div>
                <div class="dashboard-card">
                    <h2>Pruebas Funcionales</h2>
                    <p>Gesti√≥n de pruebas funcionales y comisionamiento.</p>
                </div>
            </main>

            <main v-if="currentView === 'preservationPlan'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Plan de Preservaci√≥n</h2>
                <div class="iframe-container">
                </div>
            </main>

            <main v-if="currentView === 'consumablesManagement'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Gesti√≥n de Consumibles</h2>
                <div class="iframe-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYtfoxXN6eezzw1lRh9UpAHui58k_2efsRCDhi43rlS818KnpfNOGUEoBeIV3c80QojFB3Ch1mHMbU/pubhtml?gid=1474824512&single=true&widget=false&headers=false&chrome=false&theme=light&embed=true" style="width: 100%; height: 600px; border: none; frameborder: 0; margin: 0; padding: 0; overflow: hidden; position: relative; "></iframe>
                </div>
            </main>
        </section>

        <section v-else>
            <div v-if="showLogin">
                <h2>Iniciar Sesi√≥n</h2>
                <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label for="email">Correo Electr√≥nico</label>
                        <input type="email" id="email" v-model="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a</label>
                        <div class="password-container">
                            <input :type="showPassword ? 'text' : 'password'" id="password" v-model="password" required autocomplete="current-password">
                            <span class="toggle-password" @click="showPassword = !showPassword">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <button type="submit">Ingresar</button>
                </form>
                <p>¬øNo tienes cuenta? <a href="#" @click.prevent="showLogin = false">Reg√≠strate</a></p>
            </div>

            <div v-else>
                <h2>Registrarse</h2>
                <form @submit.prevent="handleRegister">
                    <div class="form-group">
                        <label for="email">Correo Electr√≥nico</label>
                        <input type="email" id="email" v-model="email" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a</label>
                        <div class="password-container">
                            <input :type="showPassword ? 'text' : 'password'" id="password" v-model="password" required autocomplete="new-password">
                            <span class="toggle-password" @click="showPassword = !showPassword">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <button type="submit">Registrarse</button>
                </form>
                <p>¬øYa tienes cuenta? <a href="#" @click.prevent="showLogin = true">Inicia Sesi√≥n</a></p>
            </div>
        </section>
    </div>

    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { createApp } = Vue

            const app = createApp({
                data() {
                    return {
                        email: '',
                        password: '',
                        showLogin: true,
                        user: null,
                        showPassword: false,
                        showLoginErrorModal: false,
                        loginErrorMessage: '',
                        currentView: 'projectSelection',
                        projects: [],
                        selectedProject: '',
                        newProjectName: ''
                    }
                },
                methods: {
        


                    handleLogin() {
                        iniciarSesion(this.email, this.password, (error) => {
                            if (error) {
                                this.loginErrorMessage = 'Usuario o contrase√±a incorrectos. Por favor, verifique sus datos.';
                                this.showLoginErrorModal = true;
                            }
                        });
                    },
                    
                    handleRegister() {
                        registrar(this.email, this.password, (error) => {
                            if (error) {
                                console.error('Error en el registro:', error);
                                alert('Error en el registro: ' + error);
                            } else {
                                console.log('Registro exitoso, por favor inicie sesi√≥n.');
                                this.showLogin = true;
                            }
                        });
                    },
                    handleLogout() {
                        cerrarSesion();
                    },
                    createProject() {
                        crearProyecto(this.newProjectName, (error, projectId) => {
                            if (error) {
                                console.error('Error creating project:', error);
                            } else {
                                this.newProjectName = '';
                                this.loadProjects();
                                this.currentView = 'projectSelection';
                            }
                        });
                    },
                    loadProjects() {
                        cargarProyectos((error, projects) => {
                            if (error) {
                                console.error('Error loading projects:', error);
                            } else {
                                console.log('Projects loaded:', projects);
                                this.projects = projects;
                            }
                        });
                    }
                },
                mounted() {
                    firebase.auth().onAuthStateChanged(user => {
                        this.user = user;
                        if (user) {
                            this.loadProjects();
                        }
                    });
                }
            }).mount('#app')
        });
    </script>
</body>
</html>