<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATIP - Gesti√≥n de Proyectos</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <section v-if="user">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>ATIP - Gesti√≥n de Proyectos <span v-if="selectedProjectObject" :style="{ color: '#8ab4f8' }">- {{ selectedProjectObject.nombre }}</span></h1>
                <div>
                    <span>{{ user.email }}</span>
                    <button @click="handleLogout" style="margin-left: 1rem; width: auto; padding: 0.5rem 1rem;">Cerrar Sesi√≥n</button>
                </div>
            </header>

            <main v-if="currentView === 'projectSelection'">
                <h2>Seleccionar Proyecto</h2>

                <!-- Secciones generales -->
                <div class="project-selection-cards">
                    <div class="dashboard-card">
                        <span class="card-icon" aria-hidden="true">
                            <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-shield"></use></svg>
                        </span>
                        <h2>Preservaci√≥n</h2>
                        <p>Gesti√≥n de la preservaci√≥n de equipos y materiales.</p>
                        <div class="card-buttons">
                            <button class="btn-secondary" title="Abrir la hoja de consumibles" @click="currentView = 'consumablesManagement'">Gestion de Consumibles</button>
                            <button class="btn-secondary" title="Ver/editar el plan de preservaci√≥n" @click="currentView = 'preservationPlan'">Plan de Preservacion</button>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <span class="card-icon" aria-hidden="true">
                            <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-helmet"></use></svg>
                        </span>
                        <h2>Gesti√≥n HSE</h2>
                        <p>Gesti√≥n de permisos de trabajo.</p>
                        <div class="card-buttons">
                            <button class="btn-secondary" title="Administrar permisos de trabajo" @click="currentView = 'workPermits'">Permisos de Trabajo</button>
                        </div>
                    </div>
                </div>

                <div class="project-selector">
                    <select v-model="selectedProject">
                        <option disabled value="">Seleccione un proyecto</option>
                        <option v-for="project in projects" :key="project.id" :value="project.id">{{ project.nombre }}</option>
                    </select>
                    <button @click="currentView = 'dashboard'" :disabled="!selectedProject">Ir al Proyecto</button>
                    <button @click="openEditProjectModal(selectedProjectObject)" :disabled="!selectedProject" class="btn-secondary">Editar Proyecto</button>
                    <button @click="currentView = 'createProject'" class="btn-secondary">Crear Nuevo Proyecto</button>
                </div>
            </main>

            <main v-if="currentView === 'createProject'">
                <h2>Crear Nuevo Proyecto</h2>
                <form @submit.prevent="createProject">
                    <div class="form-group">
                        <label for="projectName">Nombre del Proyecto</label>
                        <input type="text" id="projectName" v-model="newProjectName" required>
                    </div>
                    <div class="form-group">
                        <label for="projectDescription">Descripci√≥n del Proyecto</label>
                        <textarea id="projectDescription" v-model="newProjectDescription"></textarea>
                    </div>
                    <button type="submit">Crear Proyecto</button>
                    <button @click="currentView = 'projectSelection'" class="btn-secondary">Cancelar</button>
                </form>
            </main>

            <main v-if="currentView === 'dashboard'" class="dashboard">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button @click="currentView = 'projectSelection'" class="btn-secondary" style="width: auto; padding: 0.5rem 1rem;">Volver a Proyectos</button>
                    <button @click="goToEngineeringData" :disabled="!selectedProject" class="btn-secondary" style="width: auto; padding: 0.5rem 1rem;">Datos de Ingenieria</button>
                </div>
                <div class="dashboard-card">
                    <span class="card-icon" aria-hidden="true">
                        <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-clipboard"></use></svg>
                    </span>
                    <h2>Faltantes constructivos</h2>
                    <p>Gesti√≥n de pendientes constructivos del proyecto.</p>
                    <div class="card-buttons">
                        <button class="btn-secondary" title="Cargar faltantes desde formulario o Excel" @click="currentView = 'createMissingItem'">Cargue de Faltantes</button>
                        <button class="btn-secondary" title="Ver y gestionar la lista de faltantes" @click="currentView = 'missingItemsManagement'">Gestion de Faltantes</button>
                    </div>
                </div>
                <div class="dashboard-card">
                    <span class="card-icon" aria-hidden="true">
                        <svg class="icon" width="32" height="32" aria-hidden="true"><use xlink:href="assets/icons.svg#icon-check"></use></svg>
                    </span>
                    <h2>Pruebas Funcionales</h2>
                    <p>Gesti√≥n de pruebas funcionales y comisionamiento.</p>
                    <div class="card-buttons">
                        <button class="btn-secondary" title="Abrir el gestor de pruebas funcionales" @click="currentView = 'functionalTests'">Gestion de Pruebas</button>
                    </div>
                </div>
            </main>

            <main v-if="currentView === 'functionalTests'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Gesti√≥n de Pruebas Funcionales</h2>
                <input type="text" v-model="instrumentFilter" placeholder="Filtrar instrumentos..." style="margin-bottom: 1rem; width: 100%; padding: 0.5rem;">
                
                <p style="margin-bottom: 1rem;">
                    Mostrando {{ incompleteInstruments.length }} instrumentos pendientes y {{ completedInstruments.length }} completados.
                </p>

                <div class="responsive-table">
                    <table class="missing-items-table">
                    <thead>
                        <tr>
                            <th>Instrumento</th>
                            <th>Estado</th>
                            <th>Fecha de Cierre</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="instrument in incompleteInstruments" :key="instrument.id">
                            <td>{{ instrument.name }}</td>
                            <td>{{ getFunctionalTestProgress(instrument.id) }}</td>
                            <td>{{ getFunctionalTestFechaCierre(instrument.id) }}</td>
                            <td>
                                <button @click="openFunctionalTestModal(instrument)" class="btn-secondary">Editar</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>
                
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Pruebas Completadas</h3>
                <div class="responsive-table">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th>Instrumento</th>
                                <th>Estado</th>
                                <th>Fecha de Cierre</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="instrument in completedInstruments" :key="instrument.id">
                                <td>{{ instrument.name }}</td>
                                <td>{{ getFunctionalTestProgress(instrument.id) }}</td>
                                <td>{{ getFunctionalTestFechaCierre(instrument.id) }}</td>
                                <td>
                                    <button @click="openFunctionalTestModal(instrument)" class="btn-secondary">Ver/Editar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>

            <div v-if="showFunctionalTestModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeFunctionalTestModal">&times;</span>
                    <h2>Prueba Funcional para {{ selectedInstrument.name }}</h2>
                    <form @submit.prevent="saveFunctionalTest">
                        <div class="form-group">
                            <label for="marca">Marca</label>
                            <input type="text" id="marca" v-model="newFunctionalTest.marca">
                        </div>
                        <div class="form-group">
                            <label for="modelo">Modelo</label>
                            <input type="text" id="modelo" v-model="newFunctionalTest.modelo">
                        </div>
                        <div class="form-group">
                            <label for="serial">Serial</label>
                            <input type="text" id="serial" v-model="newFunctionalTest.serial">
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" v-model="newFunctionalTest.ajusteCero"> Ajuste de cero</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaLazo"> Prueba de Lazo</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaAlarma"> Prueba Alarma</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaDesconexion"> Prueba Desconexion</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.limitesSaturacion"> Limites de Saturacion</label>
                            <label><input type="checkbox" v-model="newFunctionalTest.pruebaSensorDesconectado"> Prueba Sensor desconectado</label>
                        </div>
                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" v-model="newFunctionalTest.observaciones"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fechaCierre">Fecha de Cierre</label>
                            <input type="date" id="fechaCierre" v-model="newFunctionalTest.fechaCierre" aria-label="Fecha de Cierre de la prueba">
                        </div>
                        <button type="submit">Guardar</button>
                    </form>
                </div>
            </div>

            <div v-if="showEditProjectModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeEditProjectModal">&times;</span>
                    <h2>Editar Proyecto</h2>
                    <form @submit.prevent="updateProject">
                        <div class="form-group">
                            <label for="editProjectName">Nombre del Proyecto</label>
                            <input type="text" id="editProjectName" v-model="editedProjectName" required>
                        </div>
                        <div class="form-group">
                            <label for="editProjectDescription">Descripci√≥n del Proyecto</label>
                            <textarea id="editProjectDescription" v-model="editedProjectDescription"></textarea>
                        </div>
                        <button type="submit">Guardar Cambios</button>
                    </form>
                </div>
            </div>

            <main v-if="currentView === 'preservationPlan'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Plan de Preservaci√≥n</h2>
                <div class="iframe-container">
                </div>
            </main>

            <main v-if="currentView === 'consumablesManagement'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Gesti√≥n de Consumibles</h2>
                <div v-if="user && (user.email === 'contacto10@gmail.com' || user.email === 'garibello.ignacio@gmail.com')" style="margin-bottom: 1rem;">
                    <a href="https://forms.gle/vcndBzx6XUMngBto8" target="_blank" class="btn-secondary" style="display: inline-block; text-decoration: none; padding: 0.5rem 1rem;">Gestion de Consumibles</a>
                </div>
                <div class="iframe-container">
                    <iframe title="Hoja de Consumibles" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYtfoxXN6eezzw1lRh9UpAHui58k_2efsRCDhi43rlS818KnpfNOGUEoBeIV3c80QojFB3Ch1mHMbU/pubhtml?gid=1474824512&single=true&widget=false&headers=false&chrome=false&theme=light&embed=true" style="width: 100%; height: 600px; border: none; margin: 0; padding: 0; overflow: hidden; position: relative; "></iframe>
                </div>
            </main>

            <main v-if="currentView === 'workPermits'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Permisos de Trabajo</h2>
                <button @click="showWorkPermitForm = true" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Cargar Permiso</button>
                <div class="iframe-container">
                </div>
                <dialog v-if="showWorkPermitForm" class="modal" id="workpermit-dialog" aria-labelledby="workpermit-title" open>
                    <div class="modal-content">
                        <button class="close" aria-label="Cerrar" @click="showWorkPermitForm = false">&times;</button>
                        <h3 id="workpermit-title">Cargar Permiso de Trabajo</h3>
                        <form @submit.prevent="submitWorkPermit">
                            <div class="form-group"><label for="wp-numero">#</label><input id="wp-numero" type="text" v-model="newWorkPermit.numero" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-fechaSolicitud">Fecha de Solicitud</label><input id="wp-fechaSolicitud" type="date" v-model="newWorkPermit.fechaSolicitud" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-fechaInicio">Fecha de Inicio</label><input id="wp-fechaInicio" type="date" v-model="newWorkPermit.fechaInicio" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-fechaFin">Fecha de Finalizaci√≥n</label><input id="wp-fechaFin" type="date" v-model="newWorkPermit.fechaFin" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-tipo">Tipo de Permiso</label><input id="wp-tipo" type="text" v-model="newWorkPermit.tipoPermiso" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-area">√Årea</label><input id="wp-area" type="text" v-model="newWorkPermit.area" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-empresa">Empresa ejecutora</label><input id="wp-empresa" type="text" v-model="newWorkPermit.empresaEjecutora" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-especialidad">Especialidad</label><input id="wp-especialidad" type="text" v-model="newWorkPermit.especialidad" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-descripcion">Descripci√≥n</label><textarea id="wp-descripcion" v-model="newWorkPermit.descripcion" required aria-required="true"></textarea></div>
                            <div class="form-group"><label for="wp-estado">Estado</label><input id="wp-estado" type="text" v-model="newWorkPermit.estado" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-subestado">Sub-estado</label><input id="wp-subestado" type="text" v-model="newWorkPermit.subestado" required aria-required="true"></div>
                            <div class="form-group"><label for="wp-valoracion">Valoraci√≥n del Riesgo</label><input id="wp-valoracion" type="text" v-model="newWorkPermit.valoracionRiesgo" required aria-required="true"></div>
                            <div style="margin-top: 1rem; display:flex; gap:0.5rem; align-items:center; justify-content:center;">
                                <button type="submit" :disabled="isSavingWorkPermit">Guardar Permiso
                                    <span v-if="isSavingWorkPermit" class="inline-spinner" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn-secondary" @click="showWorkPermitForm = false" :disabled="isSavingWorkPermit">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </dialog>
                <output v-if="toastVisible" class="toast" aria-live="polite">{{ toastMessage }}</output>
            </main>

            <main v-if="currentView === 'createMissingItem'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Cargar Faltante Constructivo</h2>
                <div style="margin-bottom: 1rem;">
                    <input type="file" @change="handleFileUpload" accept=".xls,.xlsx" ref="fileInput" style="display: none;">
                    <button class="btn-secondary" @click="$refs.fileInput.click()">Cargue Masivo desde Excel</button>
                    <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                        El archivo de Excel debe contener las siguientes columnas: Equipo, Descripcion, Tipo (Tipo A o Tipo B), FechaCierre (YYYY-MM-DD)
                    </p>
                </div>
                <form @submit.prevent="createMissingItem">
                    <div class="form-group">
                        <label for="missingItemProject">Proyecto</label>
                        <input type="text" id="missingItemProject" :value="selectedProjectObject.nombre" disabled>
                    </div>
                    <div class="form-group">
                        <label for="missingItemEquipment">Equipo</label>
                        <input type="text" id="missingItemEquipment" v-model="newMissingItem.equipment" required>
                    </div>
                    <div class="form-group">
                        <label for="missingItemDescription">Descripci√≥n del Faltante</label>
                        <textarea id="missingItemDescription" v-model="newMissingItem.description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="missingItemType">Tipo de Faltante</label>
                        <select id="missingItemType" v-model="newMissingItem.type" required>
                            <option value="Tipo A">Tipo A</option>
                            <option value="Tipo B">Tipo B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="missingItemDate">Fecha Tentativa de Cierre</label>
                        <input type="date" id="missingItemDate" v-model="newMissingItem.closingDate" required>
                    </div>
                    <button type="submit">Crear Faltante</button>
                </form>
            </main>

            <main v-if="currentView === 'missingItemsManagement'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Gesti√≥n de Faltantes</h2>

                <div class="filter-buttons" style="margin-bottom: 1rem;">
                    <button @click="setMissingItemsFilter('All')" class="btn-secondary">Mostrar Todos</button>
                    <button @click="setMissingItemsFilter('A')" class="btn-secondary">Filtrar Tipo A</button>
                    <button @click="setMissingItemsFilter('B')" class="btn-secondary">Filtrar Tipo B</button>
                </div>

                <div class="summary" style="margin-bottom: 1rem;">
                    <p>Faltantes Tipo A: {{ summaryCounts.totalA }} (Abiertos: {{ summaryCounts.openA }}, Cerrados: {{ summaryCounts.closedA }})</p>
                    <p>Faltantes Tipo B: {{ summaryCounts.totalB }} (Abiertos: {{ summaryCounts.openB }}, Cerrados: {{ summaryCounts.closedB }})</p>
                </div>

                <div class="responsive-table">
                    <table class="missing-items-table">
                    <thead>
                        <tr>
                            <th @click="sortMissingItems('equipment')">
                                Equipo
                                <span v-if="missingItemsSortColumn === 'equipment'">
                                    <span v-if="missingItemsSortOrder === 'asc'">‚ñ≤</span>
                                    <span v-else>‚ñº</span>
                                </span>
                            </th>
                            <th>Descripci√≥n</th>
                            <th>Tipo</th>
                            <th>Fecha Cierre</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in filteredMissingItems" :key="item.id">
                            <td>{{ item.equipment }}</td>
                            <td>{{ item.description }}</td>
                            <td>{{ item.type }}</td>
                            <td>{{ item.closingDate }}</td>
                            <td>{{ item.status }}</td>
                            <td>
                                <button @click="toggleMissingItemStatus(item)" :class="item.status === 'Abierto' ? 'btn-open' : 'btn-closed'">
                                    {{ item.status === 'Abierto' ? 'Cerrar' : 'Abrir' }}
                                </button>
                            </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </main>

            <main v-if="currentView === 'engineeringData'">
                <button @click="currentView = 'dashboard'" class="btn-secondary" style="margin-bottom: 1rem; width: auto; padding: 0.5rem 1rem;">Volver al Dashboard</button>
                <h2>Datos de Ingenier√≠a</h2>
                <p>Engineering Data section is rendered.</p>

                <div class="engineering-section">
                    <h3>Descripci√≥n del Proyecto</h3>
                    <p>{{ selectedProjectObject.description || 'No hay descripci√≥n para este proyecto.' }}</p>
                </div>

                <div class="engineering-section">
                    <h3>Instrumentos Comisionables</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.instrumentsFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('instruments', engineeringData.instruments)" class="btn-secondary">Editar Informaci√≥n</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Instrumento, Rango, Alarmas, Interlocks
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('instruments', $event)" ref="instrumentsFileInput" style="display: none;" accept=".xls,.xlsx">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th @click="sortEngineering('instruments', 'name')" style="cursor:pointer;">
                                    Instrumento
                                    <span v-if="engineeringSort.type === 'instruments' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">‚ñ≤</span>
                                        <span v-else>‚ñº</span>
                                    </span>
                                </th>
                                <th>Rango</th>
                                <th>Alarmas</th>
                                <th>Interlocks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="instrument in sortedEngineeringInstruments" :key="instrument.id">
                                <td>{{ instrument.name }}</td>
                                <td>{{ instrument.range }}</td>
                                <td>{{ instrument.alarms }}</td>
                                <td>{{ instrument.interlocks }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="engineering-section">
                    <h3>Interlocks</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.interlocksFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('interlocks', engineeringData.interlocks)" class="btn-secondary">Editar Informaci√≥n</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Interlock, Causa, Efecto
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('interlocks', $event)" ref="interlocksFileInput" style="display: none;" accept=".xls,.xlsx">
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th @click="sortEngineering('interlocks', 'name')" style="cursor:pointer;">
                                    Interlock
                                    <span v-if="engineeringSort.type === 'interlocks' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">‚ñ≤</span>
                                        <span v-else>‚ñº</span>
                                    </span>
                                </th>
                                <th>Causa</th>
                                <th>Efecto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="interlock in sortedEngineeringInterlocks" :key="interlock.id">
                                <td>{{ interlock.name }}</td>
                                <td>{{ interlock.causa }}</td>
                                <td>{{ interlock.efecto }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="engineering-section">
                    <h3>Motores</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.motorsFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('motors', engineeringData.motors)" class="btn-secondary">Editar Informaci√≥n</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Motor, Descripcion
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('motors', $event)" ref="motorsFileInput" style="display: none;" accept=".xls,.xlsx" multiple>
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th @click="sortEngineering('motors', 'name')" style="cursor:pointer;">
                                    Motor
                                    <span v-if="engineeringSort.type === 'motors' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">‚ñ≤</span>
                                        <span v-else>‚ñº</span>
                                    </span>
                                </th>
                                <th>Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="motor in sortedEngineeringMotors" :key="motor.id">
                                <td>{{ motor.name }}</td>
                                <td>{{ motor.description }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="engineering-section">
                    <h3>Lazos de Control</h3>
                    <div style="margin-bottom: 1rem;">
                        <button @click="$refs.controlLoopsFileInput.click()" class="btn-secondary">Cargar desde Excel</button>
                        <button @click="openEditEngineeringDataModal('controlLoops', engineeringData.controlLoops)" class="btn-secondary">Editar Informaci√≥n</button>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">
                            El archivo de Excel debe contener las siguientes columnas: Lazo, Descripcion
                        </p>
                    </div>
                    <input type="file" @change="uploadEngineeringData('controlLoops', $event)" ref="controlLoopsFileInput" style="display: none;" accept=".xls,.xlsx" multiple>
                    <table class="missing-items-table">
                        <thead>
                            <tr>
                                <th @click="sortEngineering('controlLoops', 'name')" style="cursor:pointer;">
                                    Lazo
                                    <span v-if="engineeringSort.type === 'controlLoops' && engineeringSort.field === 'name'">
                                        <span v-if="engineeringSort.order === 'asc'">‚ñ≤</span>
                                        <span v-else>‚ñº</span>
                                    </span>
                                </th>
                                <th>Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="loop in sortedEngineeringControlLoops" :key="loop.id">
                                <td>{{ loop.name }}</td>
                                <td>{{ loop.description }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>

            <div v-if="showEditEngineeringDataModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeEditEngineeringDataModal">&times;</span>
                    <h2>{{ editModalTitle }}</h2>
                    <form @submit.prevent="updateEngineeringData">
                        <div class="form-group">
                            <label for="edit-item-select">Seleccionar Item</label>
                            <select id="edit-item-select" v-model="selectedItemId" @change="loadDataForEditing">
                                <option disabled value="">-- Seleccione un item --</option>
                                <option v-for="item in sortedEditingDataArray" :key="item.id" :value="item.id">
                                    {{ item.name || item.equipment || item.descripcion || item.serial || item.modelo || item.marca || item.id }}
                                </option>
                            </select>
                        </div>

                        <div v-if="selectedItemId">
                            <!-- Dynamic fields based on editingDataType -->
                            <template v-if="editingDataType === 'instruments'">
                                <div class="form-group">
                                    <label for="edit-instrument-name">Instrumento</label>
                                    <input type="text" id="edit-instrument-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-range">Rango</label>
                                    <input type="text" id="edit-instrument-range" v-model="editedData.range">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-alarms">Alarmas</label>
                                    <input type="text" id="edit-instrument-alarms" v-model="editedData.alarms">
                                </div>
                                <div class="form-group">
                                    <label for="edit-instrument-interlocks">Interlocks</label>
                                    <input type="text" id="edit-instrument-interlocks" v-model="editedData.interlocks">
                                </div>
                            </template>
                            <template v-if="editingDataType === 'interlocks'">
                                <div class="form-group">
                                    <label for="edit-interlock-name">Interlock</label>
                                    <input type="text" id="edit-interlock-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-interlock-causa">Causa</label>
                                    <input type="text" id="edit-interlock-causa" v-model="editedData.causa">
                                </div>
                                <div class="form-group">
                                    <label for="edit-interlock-efecto">Efecto</label>
                                    <input type="text" id="edit-interlock-efecto" v-model="editedData.efecto">
                                </div>
                            </template>
                            <template v-if="editingDataType === 'motors'">
                                <div class="form-group">
                                    <label for="edit-motor-name">Motor</label>
                                    <input type="text" id="edit-motor-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-motor-description">Descripci√≥n</label>
                                    <input type="text" id="edit-motor-description" v-model="editedData.description">
                                </div>
                            </template>
                            <template v-if="editingDataType === 'controlLoops'">
                                <div class="form-group">
                                    <label for="edit-loop-name">Lazo</label>
                                    <input type="text" id="edit-loop-name" v-model="editedData.name">
                                </div>
                                <div class="form-group">
                                    <label for="edit-loop-description">Descripci√≥n</label>
                                    <input type="text" id="edit-loop-description" v-model="editedData.description">
                                </div>
                            </template>
                        </div>

                        <button type="submit" :disabled="!selectedItemId">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </section>

        <section v-else>
            <div v-if="showLogin">
                <h2>Iniciar Sesi√≥n</h2>
                        <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label for="email">Correo Electr√≥nico</label>
                        <input type="email" id="email" name="email" v-model="email" required autocomplete="username">
                    </div>
                        <div class="form-group">
                            <label for="password">Contrase√±a</label>
                            <div class="password-container">
                                <input v-if="!showPassword" type="password" id="password" name="password" v-model="password" required autocomplete="current-password">
                                <input v-else type="text" id="password-text" v-model="password" aria-hidden="false">
                                <button type="button" class="toggle-password" @click="showPassword = !showPassword" @keydown.enter.prevent="showPassword = !showPassword" :aria-pressed="showPassword" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
                            </div>
                        </div>
                    <button type="submit">Ingresar</button>
                </form>
                <p>¬øNo tienes cuenta? <a href="#" @click.prevent="showLogin = false">Reg√≠strate</a></p>
            </div>

            <div v-else>
                <h2>Registrarse</h2>
                <form @submit.prevent="handleRegister">
                        <div class="form-group">
                        <label for="register-name">Nombre y Apellido</label>
                        <input type="text" id="register-name" name="name" v-model="fullName" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="register-email">Correo Electr√≥nico</label>
                        <input type="email" id="register-email" name="email" v-model="email" required autocomplete="email">
                    </div>
                        <div class="form-group">
                            <label for="register-password">Contrase√±a</label>
                            <div class="password-container">
                            <input v-if="!showPassword" type="password" id="register-password" name="password" v-model="password" required autocomplete="new-password" aria-describedby="register-password-help">
                            <input v-else type="text" id="register-password-text" v-model="password" aria-hidden="false">
                            <button type="button" class="toggle-password" @click="showPassword = !showPassword" @keydown.enter.prevent="showPassword = !showPassword" :aria-pressed="showPassword" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
                            </div>
                            <small id="register-password-help" style="color:var(--secondary-color);">Usa una contrase√±a segura de al menos 8 caracteres.</small>
                        </div>
                    <button type="submit">Registrarse</button>
                </form>
                <p>¬øYa tienes cuenta? <a href="#" @click.prevent="showLogin = true">Inicia Sesi√≥n</a></p>
            </div>
        </section>
    </div>

    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { createApp } = Vue

            createApp({
                data() {
                    return {
                        email: '',
                        password: '',
                        fullName: '',
                        showLogin: true,
                        user: null,
                        showPassword: false,
                        showLoginErrorModal: false,
                        loginErrorMessage: '',
                        currentView: 'projectSelection',
                        projects: [],
                        selectedProject: '',
                        newProjectName: '',
                        newProjectDescription: '',
                        newMissingItem: {
                            equipment: '',
                            description: '',
                            type: 'Tipo A',
                            closingDate: ''
                        },
                        missingItems: [],
                        missingItemsFilter: 'All',
                        missingItemsSortColumn: 'equipment',
                        missingItemsSortOrder: 'asc',
                        engineeringData: {
                            instruments: [],
                            interlocks: [],
                            motors: [],
                            controlLoops: []
                        },
                        instrumentFilter: '',
                        showFunctionalTestModal: false,
                        selectedInstrument: null,
                        showEditProjectModal: false,
                        editingProject: null,
                        editedProjectName: '',
                        editedProjectDescription: '',
                        showEditEngineeringDataModal: false,
                        editingDataType: null,
                        editingDataArray: [],
                        selectedItemId: '',
                        editedData: {},
                        functionalTests: [],
                        newFunctionalTest: {
                            marca: '',
                            modelo: '',
                            serial: '',
                            ajusteCero: false,
                            pruebaLazo: false,
                            pruebaAlarma: false,
                            pruebaDesconexion: false,
                            limitesSaturacion: false,
                            pruebaSensorDesconectado: false,
                            observaciones: '',
                            fechaCierre: ''
                        },
                        showWorkPermitForm: false,
                        newWorkPermit: {
                            numero: '',
                            fechaSolicitud: '',
                            fechaInicio: '',
                            fechaFin: '',
                            tipoPermiso: '',
                            area: '',
                            empresaEjecutora: '',
                            especialidad: '',
                            descripcion: '',
                            estado: '',
                            subestado: '',
                            valoracionRiesgo: ''
                        },
                        engineeringSort: {
                            type: '',
                            field: '',
                            order: 'asc'
                        }
                    ,
                    // UI state
                    isSavingWorkPermit: false,
                    toastMessage: '',
                    toastVisible: false
                    }
                },
                computed: {
                    sortedEngineeringInstruments() {
                        let arr = this.engineeringData.instruments || [];
                        if (this.engineeringSort.type !== 'instruments' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    sortedEngineeringInterlocks() {
                        let arr = this.engineeringData.interlocks || [];
                        if (this.engineeringSort.type !== 'interlocks' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    sortedEngineeringMotors() {
                        let arr = this.engineeringData.motors || [];
                        if (this.engineeringSort.type !== 'motors' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    sortedEngineeringControlLoops() {
                        let arr = this.engineeringData.controlLoops || [];
                        if (this.engineeringSort.type !== 'controlLoops' || this.engineeringSort.field !== 'name') return arr;
                        return [...arr].sort((a, b) => {
                            const valA = (a.name || '').toString().toLowerCase();
                            const valB = (b.name || '').toString().toLowerCase();
                            if (valA < valB) return this.engineeringSort.order === 'asc' ? -1 : 1;
                            if (valA > valB) return this.engineeringSort.order === 'asc' ? 1 : -1;
                            return 0;
                        });
                    },
                    selectedProjectObject() {
                        if (!this.selectedProject) return null;
                        return this.projects.find(p => p.id === this.selectedProject);
                    },
                    sortedMissingItems() {
                        return [...this.missingItems].sort((a, b) => {
                            const col = this.missingItemsSortColumn;
                            const order = this.missingItemsSortOrder === 'asc' ? 1 : -1;
                            
                            const valA = a[col] ? a[col].toLowerCase() : '';
                            const valB = b[col] ? b[col].toLowerCase() : '';

                            if (valA < valB) return -1 * order;
                            if (valA > valB) return 1 * order;
                            return 0;
                        });
                    },
                    filteredMissingItems() {
                        const itemsToFilter = this.sortedMissingItems;

                        if (this.missingItemsFilter === 'All') {
                            return itemsToFilter;
                        }
                        const filter = `Tipo ${this.missingItemsFilter}`;
                        return itemsToFilter.filter(item => item.type === filter);
                    },
                    summaryCounts() {
                        const totalA = this.missingItems.filter(item => item.type === 'Tipo A').length;
                        const openA = this.missingItems.filter(item => item.type === 'Tipo A' && item.status === 'Abierto').length;
                        const closedA = totalA - openA;
                        const totalB = this.missingItems.filter(item => item.type === 'Tipo B').length;
                        const openB = this.missingItems.filter(item => item.type === 'Tipo B' && item.status === 'Abierto').length;
                        const closedB = totalB - openB;
                        return { totalA, openA, closedA, totalB, openB, closedB };
                    },
                    filteredInstruments() {
                        if (!this.instrumentFilter) {
                            return this.engineeringData.instruments;
                        }
                        return this.engineeringData.instruments.filter(instrument => {
                            return instrument.name.toLowerCase().includes(this.instrumentFilter.toLowerCase());
                        });
                    },
                    incompleteInstruments() {
                        return this.filteredInstruments.filter(instrument => this.getFunctionalTestProgress(instrument.id) !== '100%');
                    },
                    completedInstruments() {
                        return this.filteredInstruments.filter(instrument => this.getFunctionalTestProgress(instrument.id) === '100%');
                    },
                    editModalTitle() {
                        if (!this.editingDataType) return '';
                        const titles = {
                            instruments: 'Instrumentos Comisionables',
                            interlocks: 'Interlocks',
                            motors: 'Motores',
                            controlLoops: 'Lazos de Control'
                        };
                        return `Editar ${titles[this.editingDataType]}`;
                    },
                    sortedEditingDataArray() {
                        if (!this.editingDataArray || !Array.isArray(this.editingDataArray)) return [];
                        // Ordena por el campo 'name', si existe, si no por otros posibles campos
                        return [...this.editingDataArray].sort((a, b) => {
                            const getSortValue = (item) => item.name || item.equipment || item.descripcion || item.serial || item.modelo || item.marca || item.id || '';
                            return getSortValue(a).localeCompare(getSortValue(b), 'es', { sensitivity: 'base' });
                        });
                    },
                },
                watch: {
                    currentView(newView, oldView) {
                        console.log(`currentView changed from ${oldView} to ${newView}`);
                        if (newView === 'missingItemsManagement') {
                            this.loadMissingItems();
                        }
                        if (newView === 'engineeringData') {
                            console.log('Loading engineering data section.');
                            this.loadEngineeringData();
                        }
                        if (newView === 'functionalTests') {
                            this.loadEngineeringData();
                            this.loadFunctionalTests();
                        }
                    }
                },
                methods: {
                    goToEngineeringData() {
                        if (!this.selectedProject) {
                            alert('Por favor, seleccione un proyecto antes de ver los datos de ingenier√≠a.');
                            return;
                        }
                        this.currentView = 'engineeringData';
                        this.$nextTick(() => {
                            this.loadEngineeringData();
                            this.$forceUpdate && this.$forceUpdate();
                        });
                    },
                    sortEngineering(type, field) {
                        if (this.engineeringSort.type === type && this.engineeringSort.field === field) {
                            this.engineeringSort.order = this.engineeringSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.engineeringSort.type = type;
                            this.engineeringSort.field = field;
                            this.engineeringSort.order = 'asc';
                        }
                    },
                    getFunctionalTestProgress(instrumentId) {
                        const test = this.functionalTests.find(t => t.instrumentId === instrumentId);
                        if (!test) {
                            return '0%';
                        }

                        // For backwards compatibility, calculate from fields if not stored
                        if (test.completedFields === undefined || test.totalFields === undefined) {
                            const fields = [
                                test.marca, test.modelo, test.serial, test.observaciones,
                                test.ajusteCero, test.pruebaLazo, test.pruebaAlarma,
                                test.pruebaDesconexion, test.limitesSaturacion, test.pruebaSensorDesconectado
                            ];
                            const totalFields = fields.length;
                            const completedFields = fields.reduce((acc, field) => {
                                if (typeof field === 'boolean') return acc + (field ? 1 : 0);
                                if (typeof field === 'string') return acc + (field.trim() !== '' ? 1 : 0);
                                return acc;
                            }, 0);
                            const percentage = (completedFields / totalFields) * 100;
                            return `${Math.round(percentage)}%`;
                        }

                        const percentage = (test.completedFields / test.totalFields) * 100;
                        return `${Math.round(percentage)}%`;
                    },
                    openFunctionalTestModal(instrument) {
                        this.selectedInstrument = instrument;
                        const test = this.functionalTests.find(t => t.instrumentId === instrument.id);
                        if (test) {
                            this.newFunctionalTest = { ...test };
                        } else {
                            this.newFunctionalTest = {
                                marca: '',
                                modelo: '',
                                serial: '',
                                ajusteCero: false,
                                pruebaLazo: false,
                                pruebaAlarma: false,
                                pruebaDesconexion: false,
                                limitesSaturacion: false,
                                pruebaSensorDesconectado: false,
                                observaciones: '',
                                fechaCierre: ''
                            };
                        }
                        this.showFunctionalTestModal = true;
                    },
                    closeFunctionalTestModal() {
                        this.showFunctionalTestModal = false;
                        this.selectedInstrument = null;
                    },
                    saveFunctionalTest() {
                        const testData = {
                            ...this.newFunctionalTest,
                            projectId: this.selectedProject,
                            instrumentId: this.selectedInstrument.id
                        };

                        // Include fechaCierre in the completion metric
                        const fields = [
                            testData.marca, testData.modelo, testData.serial, testData.observaciones, testData.fechaCierre,
                            testData.ajusteCero, testData.pruebaLazo, testData.pruebaAlarma,
                            testData.pruebaDesconexion, testData.limitesSaturacion, testData.pruebaSensorDesconectado
                        ];
                        const totalFields = fields.length;
                        let completedFields = fields.reduce((acc, f) => {
                            if (typeof f === 'boolean') return acc + (f ? 1 : 0);
                            if (typeof f === 'string') return acc + (f.trim() !== '' ? 1 : 0);
                            return acc;
                        }, 0);

                        testData.completedFields = completedFields;
                        testData.totalFields = totalFields;

                        guardarPruebaFuncional(testData, (error) => {
                            if (error) {
                                console.error('Error saving functional test:', error);
                                alert('Error al guardar la prueba funcional.');
                            } else {
                                console.log('Functional test saved successfully');
                                this.closeFunctionalTestModal();
                            }
                        });
                    },
                    getFunctionalTestFechaCierre(instrumentId) {
                        const test = this.functionalTests.find(t => t.instrumentId === instrumentId);
                        if (!test || !test.fechaCierre) return '-';
                        // Handle Firestore Timestamp or ISO string
                        const fecha = test.fechaCierre;
                        if (fecha && typeof fecha.toDate === 'function') {
                            const d = fecha.toDate();
                            return d.toISOString().slice(0,10);
                        }
                        if (typeof fecha === 'string') {
                            const parsed = Date.parse(fecha);
                            if (!isNaN(parsed)) {
                                return new Date(parsed).toISOString().slice(0,10);
                            }
                            return fecha;
                        }
                        return '-';
                    },
                    async submitWorkPermit() {
                        if (!this.selectedProject) {
                            alert('Seleccione un proyecto antes de cargar un permiso.');
                            return;
                        }

                        const permitData = {
                            ...this.newWorkPermit,
                            projectId: this.selectedProject,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        try {
                            this.isSavingWorkPermit = true;
                            await guardarDato('workPermits', this.selectedProject, permitData);
                            // reset form and close modal after successful save
                            this.newWorkPermit = {
                                numero: '',
                                fechaSolicitud: '',
                                fechaInicio: '',
                                fechaFin: '',
                                tipoPermiso: '',
                                area: '',
                                empresaEjecutora: '',
                                especialidad: '',
                                descripcion: '',
                                estado: '',
                                subestado: '',
                                valoracionRiesgo: ''
                            };
                            this.showWorkPermitForm = false;
                            this.toastMessage = 'Permiso cargado correctamente.';
                            this.toastVisible = true;
                            setTimeout(() => { this.toastVisible = false; this.toastMessage = ''; }, 3500);
                        } catch (error) {
                            console.error('Error al guardar permiso:', error);
                            this.toastMessage = 'Error al guardar el permiso. Ver consola para m√°s detalles.';
                            this.toastVisible = true;
                            setTimeout(() => { this.toastVisible = false; this.toastMessage = ''; }, 5000);
                        } finally {
                            this.isSavingWorkPermit = false;
                        }
                    },
                    loadFunctionalTests() {
                        leerDatos('pruebasFuncionales', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading functional tests:', error);
                            }
                            else {
                                this.functionalTests = data;
                            }
                        });
                    },
                    loadEngineeringData() {
                        leerDatos('instruments', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading instruments:', error);
                            }
                            else {
                                this.engineeringData.instruments = data;
                            }
                        });
                        leerDatos('interlocks', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading interlocks:', error);
                            }
                            else {
                                this.engineeringData.interlocks = data;
                            }
                        });
                        leerDatos('motors', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading motors:', error);
                            }
                            else {
                                this.engineeringData.motors = data;
                            }
                        });
                        leerDatos('controlLoops', this.selectedProject, (error, data) => {
                            if (error) {
                                console.error('Error loading control loops:', error);
                            }
                            else {
                                this.engineeringData.controlLoops = data.map(loop => ({
                                    ...loop,
                                    name: loop.name || loop.Lazo,
                                    description: loop.description || loop.Descripcion
                                }));
                            }
                        });
                    },
                    setMissingItemsFilter(type) {
                        this.missingItemsFilter = type;
                    },
                    sortMissingItems(column) {
                        if (this.missingItemsSortColumn === column) {
                            this.missingItemsSortOrder = this.missingItemsSortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.missingItemsSortColumn = column;
                            this.missingItemsSortOrder = 'asc';
                        }
                    },
                    loadMissingItems() {
                        leerFaltantes(this.selectedProject, (error, faltantes) => {
                            if (error) {
                                console.error('Error loading missing items:', error);
                                alert('Error al cargar los faltantes.');
                            } else {
                                this.missingItems = faltantes.map(item => {
                                    let normalizedType = '';
                                    if (item.type) {
                                        const typeStr = item.type.trim().toLowerCase();
                                        if (typeStr === 'a' || typeStr === 'tipo a') {
                                            normalizedType = 'Tipo A';
                                        } else if (typeStr === 'b' || typeStr === 'tipo b') {
                                            normalizedType = 'Tipo B';
                                        }
                                    }
                                    return {
                                        ...item,
                                        type: normalizedType
                                    };
                                });
                            }
                        });
                    },
                    toggleMissingItemStatus(item) {
                        const newStatus = item.status === 'Abierto' ? 'Cerrado' : 'Abierto';
                        actualizarEstadoFaltante(item.id, newStatus, (error) => {
                            if (error) {
                                console.error('Error updating status:', error);
                                alert('Error al actualizar el estado.');
                            } else {
                                console.log('Status updated successfully');
                            }
                        });
                    },
                    handleFileUpload(event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const json = XLSX.utils.sheet_to_json(worksheet);

                                const faltantes = json.map(row => ({
                                    projectId: this.selectedProject,
                                    equipment: row.Equipo,
                                    description: row.Descripcion,
                                    type: row.Tipo,
                                    closingDate: row.FechaCierre,
                                    status: 'Abierto',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                }));

                                batchSave('faltantes', faltantes, this.selectedProject, (error) => {
                                    if (error) {
                                        console.error('Error saving batch:', error);
                                        alert('Error al cargar los faltantes.');
                                    } else {
                                        alert('Cargue masivo de faltantes exitoso.');
                                    }
                                });
                            };
                            reader.readAsArrayBuffer(file);
                        }
                    },
                    uploadEngineeringData(dataType, event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet);

                            if (dataType === 'instruments') {
                                const instruments = json.map(row => ({
                                    name: row.Instrumento || '',
                                    range: row.Rango || '',
                                    alarms: row.Alarmas || '',
                                    interlocks: row.Interlocks || '',
                                }));
                                // Call the existing upsert function
                                batchUpsertInstruments(dataType, instruments, this.selectedProject, (error) => {
                                    if (error) {
                                        console.error(`Error upserting instruments:`, error);
                                        alert(`Error al cargar los datos de instrumentos.`);
                                    } else {
                                        alert(`Cargue masivo de instrumentos exitoso. Los registros existentes fueron actualizados.`);
                                    }
                                });
                            } else {
                                // Keep original logic for other data types
                                let documents;
                                if (dataType === 'controlLoops') {
                                    documents = json.map(row => ({
                                        name: row.Lazo || '',
                                        description: row.Descripcion || '',
                                    }));
                                } else if (dataType === 'interlocks') {
                                    documents = json.map(row => ({
                                        name: (row.Interlock || '').toString().trim(),
                                        causa: row.Causa || '',
                                        efecto: row.Efecto || ''
                                    }));
                                    // Upsert interlocks by 'name' to avoid duplicates
                                    if (documents.length) {
                                        // call the upsert helper defined in app.js
                                        upsertDocumentsByName('interlocks', documents, this.selectedProject, 'name', (error) => {
                                            if (error) {
                                                console.error(`Error upserting interlocks:`, error);
                                                alert(`Error al cargar los interlocks.`);
                                            } else {
                                                alert(`Cargue masivo de interlocks exitoso. Los registros existentes fueron actualizados.`);
                                                // reload data
                                                this.loadEngineeringData();
                                            }
                                        });
                                        // skip the default batchSave below
                                        return;
                                    }
                                } else if (dataType === 'motors') {
                                    documents = json.map(row => ({
                                        name: row.Motor || '',
                                        description: row.Descripcion || '',
                                    }));
                                } else {
                                    documents = json.map(row => ({ ...row }));
                                }
                                // Use the old batchSave for other types
                                batchSave(dataType, documents, this.selectedProject, (error) => {
                                    if (error) {
                                        console.error(`Error saving batch for ${dataType}:`, error);
                                        alert(`Error al cargar los datos de ${dataType}.`);
                                    } else {
                                        alert(`Cargue masivo de ${dataType} exitoso.`);
                                    }
                                });
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    },
                    createMissingItem() {
                        const faltante = {
                            projectId: this.selectedProject,
                            equipment: this.newMissingItem.equipment,
                            description: this.newMissingItem.description,
                            type: this.newMissingItem.type,
                            closingDate: this.newMissingItem.closingDate,
                            status: 'Abierto',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        guardarFaltante(faltante, (error, id) => {
                            if (error) {
                                console.error('Error creating missing item:', error);
                                alert('Error al crear el faltante.');
                            } else {
                                console.log('Missing item created with id:', id);
                                // Reset form
                                this.newMissingItem = {
                                    equipment: '',
                                    description: '',
                                    type: 'Tipo A',
                                    closingDate: ''
                                };
                                this.currentView = 'dashboard';
                            }
                        });
                    },
                    handleLogin() {
                        iniciarSesion(this.email, this.password, (error) => {
                            if (error) {
                                this.loginErrorMessage = 'Usuario o contrase√±a incorrectos. Por favor, verifique sus datos.';
                                this.showLoginErrorModal = true;
                            }
                        });
                    },
                    
                    handleRegister() {
                        registrar(this.email, this.password, this.fullName, (error) => {
                            if (error) {
                                console.error('Error en el registro:', error);
                                alert('Error en el registro: ' + error);
                            }
                            else {
                                console.log('Registro exitoso, por favor inicie sesi√≥n.');
                                this.showLogin = true;
                            }
                        });
                    },
                    handleLogout() {
                        cerrarSesion();
                    },
                    createProject() {
                        crearProyecto(this.newProjectName, this.newProjectDescription, (error, projectId) => {
                            if (error) {
                                console.error('Error creating project:', error);
                            } else {
                                this.newProjectName = '';
                                this.newProjectDescription = '';
                                this.loadProjects();
                                this.currentView = 'projectSelection';
                            }
                        });
                    },
                    loadProjects() {
                        cargarProyectos((error, projects) => {
                            if (error) {
                                console.error('Error loading projects:', error);
                            }
                            else {
                                console.log('Projects loaded:', projects);
                                this.projects = projects;
                            }
                        });
                    },
                    openEditProjectModal(project) {
                        if (!project) return;
                        this.editingProject = project;
                        this.editedProjectName = project.nombre;
                        this.editedProjectDescription = project.description || '';
                        this.showEditProjectModal = true;
                    },
                    closeEditProjectModal() {
                        this.showEditProjectModal = false;
                        this.editingProject = null;
                        this.editedProjectName = '';
                        this.editedProjectDescription = '';
                    },
                    updateProject() {
                        if (!this.editingProject) return;
                        const updatedData = {
                            nombre: this.editedProjectName,
                            description: this.editedProjectDescription
                        };
                        actualizarProyecto(this.editingProject.id, updatedData, (error) => {
                            if (error) {
                                console.error('Error updating project:', error);
                                alert('Error al actualizar el proyecto.');
                            } else {
                                console.log('Project updated successfully');
                                this.closeEditProjectModal();
                                this.loadProjects(); // Reload projects to reflect changes
                            }
                        });
                    },
                    openEditEngineeringDataModal(type, data) {
                        this.editingDataType = type;
                        this.editingDataArray = data;
                        this.showEditEngineeringDataModal = true;
                    },
                    closeEditEngineeringDataModal() {
                        this.showEditEngineeringDataModal = false;
                        this.editingDataType = null;
                        this.editingDataArray = [];
                        this.selectedItemId = '';
                        this.editedData = {};
                    },
                    loadDataForEditing() {
                        if (!this.selectedItemId) {
                            this.editedData = {};
                            return;
                        }
                        const item = this.editingDataArray.find(i => i.id === this.selectedItemId);
                        if (item) {
                            this.editedData = { ...item };
                        }
                    },
                    updateEngineeringData() {
                        if (!this.selectedItemId || !this.editingDataType) return;
                        actualizarDatoIngenieria(this.editingDataType, this.selectedItemId, this.editedData, (error) => {
                            if (error) {
                                console.error('Error updating engineering data:', error);
                                alert('Error al actualizar los datos de ingenier√≠a.');
                            } else {
                                console.log('Engineering data updated successfully');
                                this.closeEditEngineeringDataModal();
                                this.loadEngineeringData(); // Reload data
                            }
                        });
                    }, 
                    deleteEngineeringData(item) {

                        const dataTypeMap = {
                            instruments: 'instrumento',
                            interlocks: 'interlock',
                            motors: 'motor',
                            controlLoops: 'lazo de control'
                        };
                        const typeName = dataTypeMap[this.editingDataType] || 'elemento';
                        if (confirm(`¬øEst√°s seguro de que deseas eliminar el ${typeName} "${item.name}"?`)) {
                            eliminarDatoIngenieria(this.editingDataType, item.id, (error) => {
                                if (error) {
                                    console.error(`Error deleting ${typeName}:`, error);
                                    alert(`Error al eliminar el ${typeName}.`);
                                } else {
                                    alert(`${typeName.charAt(0).toUpperCase() + typeName.slice(1)} eliminado con √©xito.`);
                                    // The list will update automatically thanks to onSnapshot
                                }
                            });
                        }
                    }
                },
                mounted() {
                    firebase.auth().onAuthStateChanged(user => {
                        this.user = user;
                        if (user) {
                            this.loadProjects();
                        }
                    });
                }
            }).mount('#app')
        });
    </script>
</body>
</html>